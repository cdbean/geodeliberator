var GeoAnnotator={currUserId:"0",currGroupId:"0",currIssueId:"0",currCommentId:"0",currFootprintId:"0",currLayoutId:"",currLayoutExtent:"",currPageId:"",baseUrl:"../lancelot_grail_service/",init:function(){this.currUserId="0";this.currGroupId="0";this.currIssueId="0";this.currCommentId="0";this.currFootprintId="0";this.currLayoutId="";this.currLayoutExtent="";this.currPageId="";GeoAnnotator.ContainerTBCtrl.init();GeoAnnotator.MapPanelCtrl.init();GeoAnnotator.TimelinePanelCtrl.init();GeoAnnotator.AnnotationInfoPanelCtrl.init();GeoAnnotator.ContributePanelCtrl.init();GeoAnnotator.ManageWindowCtrl.init();GeoAnnotator.AnnotationBookmarkWindowCtrl.init();GeoAnnotator.AnnotationHistoryWindowCtrl.init();this.currUserId=Ext.state.Manager.get("userId","0");var a=Ext.urlDecode(location.search.substring(1));this.currUserId=a.userId||this.currUserId;this.currGroupId=a.groupId||this.currGroupId;GeoAnnotator.ContainerTBCtrl.update();if(this.currUserId!=="0"){GeoAnnotator.ManageWindowCtrl.update()}if(this.currGroupId!=="0"){this.currIssueId=a.issueId||this.currIssueId;this.currCommentId=a.commentId||this.currCommentId;if(this.currIssueId!=="0"||this.currCommentId!=="0"){GeoAnnotator.AnnotationInfoPanelCtrl.update()}GeoAnnotator.TimelinePanelCtrl.update();GeoAnnotator.MapPanelCtrl.update();GeoAnnotator.ManageWindowCtrl.update()}}};GeoAnnotator.ContainerTBCtrl={containerTB:null,currUserInfo:{},currGroupInfo:{},logInWindow:null,manuscriptInfoWindow:null,manuscriptList:null,register:function(a){GeoAnnotator.ContainerTBCtrl.containerTB=a},init:function(){thisCtrl=GeoAnnotator.ContainerTBCtrl;thisCtrl.currUserInfo={};thisCtrl.currGroupInfo={};thisCtrl.updatePanelContent()},update:function(){thisCtrl=GeoAnnotator.ContainerTBCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"User/",success:thisCtrl.onLoadUserInfoSuccess,failure:thisCtrl.onLoadUserInfoFailure,params:{userId:GeoAnnotator.currUserId}})},updatePanelContent:function(){thisCtrl=GeoAnnotator.ContainerTBCtrl;if(thisCtrl.containerTB.items){thisCtrl.containerTB.removeAll()}var a=[["31","Amsterdam BPH 1"],["33","Rennes BM 255"],["34","Le Mans MM 354"]];var b=new Ext.data.ArrayStore({fields:["id","name"],data:a});thisCtrl.manuscriptList=new Ext.form.ComboBox({store:b,displayField:"name",typeAhead:true,mode:"local",triggerAction:"all",emptyText:"Select a manuscript...",selectOnFocus:true,listeners:{select:thisCtrl.onManuscriptListSelect}});thisCtrl.containerTB.add({xtype:"tbtext",text:"Current Manuscript: "});thisCtrl.containerTB.add(thisCtrl.manuscriptList);thisCtrl.containerTB.add("-");thisCtrl.containerTB.add({id:"manuscript-id-btn",text:"Manuscript Info",iconCls:"detail-icon",disabled:true,listeners:{click:thisCtrl.onManuscriptDetailClick}});thisCtrl.containerTB.add(" ");thisCtrl.containerTB.add({id:"timeline-btn",iconCls:"timeline-icon",disabled:true,pressed:false,enableToggle:true,toggleHandler:function(c,d){if(d){GeoAnnotator.TimelinePanelCtrl.containerPanel.expand(false)}else{GeoAnnotator.TimelinePanelCtrl.containerPanel.collapse(false)}},text:"Timeline",tooltip:{title:"Timeline",text:"Show the timeline"}});thisCtrl.containerTB.add({id:"annotation-history-btn",iconCls:"annotation-history-tab",disabled:true,pressed:false,enableToggle:true,toggleHandler:function(c,d){if(d){GeoAnnotator.AnnotationHistoryWindowCtrl.containerWindow.show()}else{GeoAnnotator.AnnotationHistoryWindowCtrl.containerWindow.hide()}},text:"History",tooltip:{title:"History",text:"Show the browsing history"}});thisCtrl.containerTB.add({id:"annotation-bookmark-btn",iconCls:"annotation-bookmark-tab",disabled:true,pressed:false,enableToggle:true,toggleHandler:function(c,d){if(d){GeoAnnotator.AnnotationBookmarkWindowCtrl.containerWindow.show()}else{GeoAnnotator.AnnotationBookmarkWindowCtrl.containerWindow.hide()}},text:"Bookmarks",tooltip:{title:"Bookmarks",text:"Show the browsing bookmarks"}});if(GeoAnnotator.currUserId!="0"){thisCtrl.containerTB.add("->");thisCtrl.containerTB.add({xtype:"tbtext",text:"Welcome, "+thisCtrl.currUserInfo.userName+"!"});thisCtrl.containerTB.add("-");thisCtrl.containerTB.add({text:"Log Out",listeners:{click:thisCtrl.onLogOutClick}})}else{thisCtrl.containerTB.add("->");thisCtrl.containerTB.add({text:"Log In",listeners:{click:thisCtrl.onLogInClick}})}thisCtrl.containerTB.doLayout()},onLogInClick:function(){var b=GeoAnnotator.ContainerTBCtrl;if(!b.logInWindow){var a=new Ext.FormPanel({labelWidth:80,url:GeoAnnotator.baseUrl+"Login/",frame:true,title:"Please Login",defaultType:"textfield",monitorValid:true,items:[{fieldLabel:"Username",name:"userName",allowBlank:false},{fieldLabel:"Password",name:"password",inputType:"password",allowBlank:false}],buttons:[{text:"Login",formBind:true,handler:function(){a.getForm().submit({method:"POST",waitTitle:"Connecting",waitMsg:"Sending data...",success:function(c,d){var e=Ext.util.JSON.decode(d.response.responseText);GeoAnnotator.currGroupId="0";GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId="0";GeoAnnotator.currFootprintId="0";GeoAnnotator.currLayoutId="";GeoAnnotator.currLayoutExtent="";GeoAnnotator.currPageId="";GeoAnnotator.ContainerTBCtrl.init();GeoAnnotator.MapPanelCtrl.init();GeoAnnotator.TimelinePanelCtrl.init();GeoAnnotator.AnnotationInfoPanelCtrl.init();GeoAnnotator.ContributePanelCtrl.init();GeoAnnotator.ManageWindowCtrl.init();GeoAnnotator.AnnotationHistoryWindowCtrl.init();GeoAnnotator.AnnotationBookmarkWindowCtrl.init();GeoAnnotator.currUserId=e.data.userId;Ext.state.Manager.set("userId",GeoAnnotator.currUserId);GeoAnnotator.ContainerTBCtrl.update();GeoAnnotator.ContainerTBCtrl.logInWindow.hide()},failure:function(c,d){if(d.failureType=="server"){obj=Ext.util.JSON.decode(d.response.responseText);Ext.Msg.alert("Login Failed!",obj.errors.reason)}else{Ext.Msg.alert("Warning!","Authentication server is unreachable : "+d.response.responseText)}a.getForm().reset()}})}}]});b.logInWindow=new Ext.Window({layout:"fit",width:300,height:150,closeAction:"hide",plain:true,modal:true,items:[a]});b.logInWindow.on("hide",function(){a.getForm().reset()})}b.logInWindow.show()},onLogOutClick:function(){Ext.state.Manager.clear("userId");GeoAnnotator.init()},onLoadUserInfoSuccess:function(b){thisCtrl=GeoAnnotator.ContainerTBCtrl;thisCtrl.currUserInfo=Ext.util.JSON.decode(b.responseText);if(thisCtrl.currUserInfo!=null){thisCtrl.updatePanelContent();if(GeoAnnotator.currUserId!="0"){var a=Ext.state.Manager.get("userId","0");if(GeoAnnotator.currUserId!=a){Ext.state.Manager.set("userId",GeoAnnotator.currUserId)}else{if(Ext.state.Manager.get("groupId","0")!="0"){}}}}},onLoadUserInfoFailure:function(){alert("Failed to load user information!")},onManuscriptListSelect:function(d,a,c){var e=a.get("id");if(e&&GeoAnnotator.currGroupId!=e){GeoAnnotator.currGroupId=e;thisCtrl.containerTB.getComponent("manuscript-id-btn").enable();thisCtrl.containerTB.getComponent("timeline-btn").enable();thisCtrl.containerTB.getComponent("annotation-history-btn").enable();thisCtrl.containerTB.getComponent("annotation-bookmark-btn").enable()}GeoAnnotator.currPageId="";GeoAnnotator.TimelinePanelCtrl.update();var b={};if(GeoAnnotator.currUserId!="0"){b.userId=GeoAnnotator.currUserId}if(GeoAnnotator.currGroupId!="0"){b.groupId=GeoAnnotator.currGroupId}GeoAnnotator.MapPanelCtrl.update(b);GeoAnnotator.ManageWindowCtrl.update()},onManuscriptDetailClick:function(){var a=GeoAnnotator.ContainerTBCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Group/",success:a.onLoadManuscriptInfoSuccess,failure:a.onLoadManuscriptInfoFailure,params:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId}})},onLoadManuscriptInfoSuccess:function(b){var a=GeoAnnotator.ContainerTBCtrl;a.currGroupInfo=Ext.util.JSON.decode(b.responseText);if(a.currGroupInfo!=null){a.showManuscriptInfo();if(GeoAnnotator.currUserId!="0"&&GeoAnnotator.currGroupId!="0"){Ext.state.Manager.set("userId",GeoAnnotator.currUserId);Ext.state.Manager.set("groupId",GeoAnnotator.currGroupId)}}},onLoadManuscriptInfoFailure:function(){alert("Failed to load manuscript information!")},showManuscriptInfo:function(){var a=GeoAnnotator.ContainerTBCtrl;html='<div id="groupGeneralInfo">'+a.currGroupInfo.mission+"</div>";if(!a.manuscriptInfoWindow){a.manuscriptInfoWindow=new Ext.Window({layout:"fit",width:500,height:500,autoScroll:true,closeAction:"hide",plain:true,modal:false,html:html,});a.manuscriptInfoWindow.on("hide",function(){GeoAnnotator.ContainerTBCtrl.manuscriptInfoWindow.body.update("")})}else{a.manuscriptInfoWindow.body.update(html)}a.manuscriptInfoWindow.show();a.manuscriptInfoWindow.alignTo(a.containerTB.getComponent("manuscript-id-btn").el,"tl-tl")}};GeoAnnotator.ContributePanelCtrl={containerPanel:null,contributeFormPanel:null,newFootprints:[],register:function(a){GeoAnnotator.ContributePanelCtrl.containerPanel=a},init:function(){var a=GeoAnnotator.ContributePanelCtrl;a.newFootprints=[];if(!a.contributeFormPanel){a.createContributePanel()}else{a.onContributeReset()}a.containerPanel.collapse(false)},update:function(){var a=GeoAnnotator.ContributePanelCtrl;a.onContributeReset()},createContributePanel:function(){var a=GeoAnnotator.ContributePanelCtrl;a.contributeFormPanel=new Ext.FormPanel({id:"contribute-form",labelAlign:"top",frame:true,autoHeight:true,bodyStyle:"padding: 0 5 0 5;",items:[{xtype:"hidden",id:"newAnnotationId",name:"newAnnotationId",value:"0"},{xtype:"htmleditor",id:"newAnnotationContent",name:"newAnnotationContent",fieldLabel:"Content",enableFont:false,enableLists:false,enableAlignments:false,height:150,width:330,autoScroll:true,anchor:"100%"},{xtype:"radiogroup",fieldLabel:"Visible to",hideLabel:false,name:"shareLevelGroup",id:"shareLevelGroup",columns:2,items:[{boxLabel:"everyone",name:"shareLevel",inputValue:0,checked:true},{boxLabel:"registered users",name:"shareLevel",inputValue:1},{boxLabel:"group members",name:"shareLevel",inputValue:2},{boxLabel:"myself",name:"shareLevel",inputValue:3}]}],buttons:[{text:"Submit",handler:a.onContributeSubmit},{text:"Cancel",handler:a.onContributeReset}]});a.containerPanel.add(a.contributeFormPanel);a.containerPanel.doLayout();a.containerPanel.on("collapse",function(){var b=GeoAnnotator.MapPanelCtrl.containerPanel.getTopToolbar().items.get("toolbox-group");if(b){b.items.get("contribute-btn").toggle(false)}GeoAnnotator.MapPanelCtrl.setNavigationMode()});a.containerPanel.on("expand",function(){var b=GeoAnnotator.MapPanelCtrl.containerPanel.getTopToolbar().items.get("toolbox-group");if(b){b.items.get("contribute-btn").toggle(true)}a.contributeFormPanel.findById("newAnnotationContent").focus()})},getContextMap:function(){var b=GeoAnnotator.MapPanelCtrl.map;var a=new XMLWriter();a.writeStartDocument();a.writeStartElement("contextmap");var l=b.getZoom();var g=b.getCenter().lon;var e=b.getCenter().lat;a.writeAttributeString("zoom",l);a.writeAttributeString("centerX",g);a.writeAttributeString("centerY",e);a.writeStartElement("options");if(b.projection!=null){a.writeStartElement("option");a.writeAttributeString("key","projection");a.writeAttributeString("value",b.projection);a.writeEndElement()}if(b.displayProjection!=null){a.writeStartElement("option");a.writeAttributeString("key","displayProjection");a.writeAttributeString("value",b.displayProjection);a.writeEndElement()}if(b.units!=null){a.writeStartElement("option");a.writeAttributeString("key","units");a.writeAttributeString("value",b.units);a.writeEndElement()}if(b.maxResolution!=null){a.writeStartElement("option");a.writeAttributeString("key","maxResolution");a.writeAttributeString("value",b.maxResolution);a.writeEndElement()}if(b.maxExtent!=null){a.writeStartElement("option");a.writeAttributeString("key","maxExtent");a.writeAttributeString("value",b.maxExtent.toBBOX(8));a.writeEndElement()}if(b.numZoomLevels!=null){a.writeStartElement("option");a.writeAttributeString("key","numZoomLevels");a.writeAttributeString("value",b.numZoomLevels);a.writeEndElement()}a.writeEndElement();var f=GeoAnnotator.MapPanelCtrl.currLayers;if(f.length>0){a.writeStartElement("layers");for(var h=0;h<f.length;h++){a.writeStartElement("layer");a.writeAttributeString("name",f[h].name);switch(f[h].CLASS_NAME){case"OpenLayers.Layer.Google":a.writeAttributeString("type","Google");break;case"OpenLayers.Layer.WMS":a.writeAttributeString("type","WMS");if(f[h].url!=undefined&&f[h].url!=null){a.writeElementString("url",f[h].url)}var d=f[h].params;if(d!=undefined&d!=null){a.writeStartElement("params");for(var k in d){var j=d[k];if(j!=undefined&&j!=null){a.writeStartElement("param");a.writeAttributeString("key",k);a.writeAttributeString("value",j);a.writeEndElement()}}a.writeEndElement()}break;case"OpenLayers.Layer.GML":a.writeAttributeString("type","GML");if(f[h].url!=undefined&&f[h].url!=null){a.writeElementString("url",f[h].url)}break;default:break}var m=f[h].options;if(m!=undefined&&m!=null){a.writeStartElement("options");for(var k in m){var j=m[k];if(j!=undefined&&j!=null){if(k!="formatOptions"&&k!="visibility"){a.writeStartElement("option");a.writeAttributeString("key",k);if(k=="format"){a.writeAttributeString("value",new j().CLASS_NAME)}else{if(f[h].CLASS_NAME=="OpenLayers.Layer.Google"&&k=="type"){a.writeAttributeString("value",j.toString())}else{a.writeAttributeString("value",j)}}a.writeEndElement()}}}a.writeStartElement("option");a.writeAttributeString("key","visibility");a.writeAttributeString("value",f[h].visibility);a.writeEndElement();a.writeEndElement()}if(m.formatOptions!=undefined&&m.formatOptions!=null){a.writeStartElement("formatOptions");var c=m.formatOptions;for(var k in c){var j=c[k];if(j!=undefined&&j!=null){a.writeStartElement("formatOption");a.writeAttributeString("key",k);a.writeAttributeString("value",j);a.writeEndElement()}}a.writeEndElement()}a.writeEndElement()}a.writeEndElement()}a.writeEndElement();a.writeEndDocument();return a.flush()},addFootprintToReference:function(d,b){var c=GeoAnnotator.ContributePanelCtrl;var a=c.contributeFormPanel.getForm().findField("newAnnotationContent");a.focus();var e='<a href="#" class="ref-link" id="ref-fp'+d+'">'+b+"</a>";a.setValue(a.getValue()+e)},removeFootprintFromReference:function(l){var c=GeoAnnotator.ContributePanelCtrl;var g=c.contributeFormPanel.getForm().findField("newAnnotationContent");var h=g.getValue();var j=/<a href=\"#\" class=\"ref-link\" id=\"ref-([fp,an]+-?[0-9]+)\">([a-z,0-9,_,\s,\-,\[,\]]+)<\/a>/gi;var k=h;if(j.test(k)){j.lastIndex=0;var e=[];var f;while((f=j.exec(k))!==null){if(f[0]===""){j.lastIndex+=1}else{e.push({result:f,lastIndex:j.lastIndex})}}for(var d=0;d<e.length;d++){var f=e[d].result;var b=f[1];var a=f[2];if(b==="fp"+l){h=h.replace(f[0],"")}}}g.setValue(h)},addAnnotationToReference:function(e,b){var c=GeoAnnotator.ContributePanelCtrl;var a=c.contributeFormPanel.getForm().findField("newAnnotationContent");a.focus();var d='<a href="#" class="ref-link" id="ref-an'+e+'">'+b+"</a>";a.setValue(a.getValue()+d)},removeAnnotationFromReference:function(l){var c=GeoAnnotator.ContributePanelCtrl;var g=c.contributeFormPanel.getForm().findField("newAnnotationContent");var h=g.getValue();var j=/<a href=\"#\" class=\"ref-link\" id=\"ref-([fp,an]+-?[0-9]+)\">([a-z,0-9,_,\s,\-,\[,\]]+)<\/a>/gi;var k=h;if(j.test(k)){j.lastIndex=0;var e=[];var f;while((f=j.exec(k))!==null){if(f[0]===""){j.lastIndex+=1}else{e.push({result:f,lastIndex:j.lastIndex})}}for(var d=0;d<e.length;d++){var f=e[d].result;var b=f[1];var a=f[2];if(b==="an"+fpId){h=h.replace(f[0],"")}}}g.setValue(h)},onContributeSubmit:function(){var c=GeoAnnotator.ContributePanelCtrl;var p={};p.id=c.contributeFormPanel.getForm().findField("newAnnotationId").getValue();p.content=c.contributeFormPanel.getForm().findField("newAnnotationContent").getValue();if(p.content.length==0){Ext.Msg.alert("Error","The content of the annotation cannot be empty");return}p.userId=GeoAnnotator.currUserId;p.groupId=GeoAnnotator.currGroupId;var m=c.contributeFormPanel.getForm().findField("shareLevelGroup").items;p.shareLevel=0;for(var e=0;e<m.items.length;e++){if(m.items[e].checked){p.shareLevel=m.items[e].inputValue;break}}p.issue=false;p.timeCreated=new Date().toGMTString();p.contextMap=c.getContextMap();p.footprints=[];p.references=[];var h=/<a href=\"#\" class=\"ref-link\" id=\"ref-([fp,an]+-?[0-9]+)\">([a-z,0-9,_,\s,\-,\[,\]]+)<\/a>/gi;var k=p.content;if(h.test(k)){h.lastIndex=0;var f=[];var g;while((g=h.exec(k))!==null){if(g[0]===""){h.lastIndex+=1}else{f.push({result:g,lastIndex:h.lastIndex})}}for(var e=0;e<f.length;e++){var g=f[e].result;var b=g[1];var a=g[2];if(b.indexOf("fp")===0){var l=false;for(var d=0;d<p.footprints.length;d++){if(p.footprints[d].id===b.substring(2)){l=true;break}}if(!l){var o={};o.alias=a;o.id=b.substring(2);if(b.indexOf("fp-")===0){for(var d=0;d<c.newFootprints.length;d++){var n=c.newFootprints[d];if(o.id==n.attributes.id){o.shape=new OpenLayers.Format.WKT().write(n);o.groupId=n.attributes.groupId;p.footprints.push(o);break}}}else{p.footprints.push(o)}}}else{if(b.indexOf("an")===0){var l=false;for(var d=0;d<p.references.length;d++){if(p.references[d]===b.substring(2)){l=true;break}}if(!l){p.references.push(b.substring(2))}}}}}c.submitContributeFormData(p)},onContributeReset:function(){var c=GeoAnnotator.ContributePanelCtrl;c.contributeFormPanel.getForm().findField("newAnnotationId").setValue("0");c.contributeFormPanel.getForm().findField("newAnnotationContent").setValue("");var b=c.contributeFormPanel.getForm().findField("shareLevelGroup").items;if(b&&b.items){for(var a=0;a<b.items.length;a++){if(a==0){b.items[a].setValue(true)}else{b.items[a].setValue(false)}}}c.containerPanel.collapse(false)},submitContributeFormData:function(b){var a=GeoAnnotator.ContributePanelCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotation/",success:a.onAddNewAnnotationSuccess,failure:a.onAddNewAnnotationFailure,params:{"new":Ext.util.JSON.encode(b),userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId}})},onAddNewAnnotationSuccess:function(d){var b=GeoAnnotator.ContributePanelCtrl;var c=Ext.util.JSON.decode(d.responseText);if(c.success==true){b.newFootprints=[];GeoAnnotator.currFootprintId="0";if(c.data.type=="issue"){GeoAnnotator.currIssueId=c.data.id;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currCommentId=c.data.id;GeoAnnotator.currIssueId="0"}GeoAnnotator.TimelinePanelCtrl.update();GeoAnnotator.AnnotationInfoPanelCtrl.update();GeoAnnotator.ContributePanelCtrl.update();var a={};if(GeoAnnotator.currUserId!="0"){a.userId=GeoAnnotator.currUserId}if(GeoAnnotator.currGroupId!="0"){a.groupId=GeoAnnotator.currGroupId}GeoAnnotator.MapPanelCtrl.update(a);GeoAnnotator.ManageWindowCtrl.update();b.containerPanel.collapse(false)}else{alert(c.data.message)}},onAddNewAnnotationFailoure:function(){alert("failed to add new annotation")}};GeoAnnotator.MapPanelCtrl={containerPanel:null,map:null,mapDiv:"mapDiv",baseLayer:null,currLayers:[],currPageBox:null,annotationVectors:null,newFootprintVectors:null,annotationDistVectors:null,footprintStyle:null,newfootprintStyle:null,navigationControl:null,modifyNewFootprintControl:null,selectFootprintControl:null,drawFootprintControl:null,hoverFeature:null,contextMenu:null,annotationListWindow:null,annotationListStore:null,annotationListView:null,currMapInfo:{},currPageViewMode:"facing",register:function(a){GeoAnnotator.MapPanelCtrl.containerPanel=a},init:function(){var c=GeoAnnotator.MapPanelCtrl;c.currMapInfo={};c.currLayers=[];c.hoverFeature=null;c.contextMenu=null;c.annotationListStore=null;c.annotationListView=null;if(c.navigationControl&&c.navigationControl.events){c.navigationControl.events.un({activate:c.onNavigationActivate,deactivate:c.onNavigationDeactivate,scope:c})}if(c.map!=null){c.map.destroy()}if(c.containerPanel.items){c.containerPanel.removeAll()}if(c.annotationListWindow){c.annotationListWindow.close();c.annotationListWindow=null}c.containerPanel.body.update('<div id="'+c.mapDiv+'"></div>');var b={maxExtent:new OpenLayers.Bounds(-180,-88.759,180,88.759),controls:[]};c.buildMap(c.mapDiv,b);c.baseLayer=new OpenLayers.Layer.Image("Lancelot Grail","http://vrcoll.fa.pitt.edu/stones-www/kissbig.gif",new OpenLayers.Bounds(-180,-88.759,180,88.759),new OpenLayers.Size(539,400),{numZoomLevels:1});c.currLayers.push(c.baseLayer);c.map.addLayers(c.currLayers);c.map.zoomToMaxExtent();c.containerPanel.getEl().on("contextmenu",function(f,i){var g=GeoAnnotator.MapPanelCtrl;if(!g.contextMenu){g.contextMenu=new Ext.menu.Menu({id:"map-panel-ctx",items:[]})}g.contextMenu.removeAll();if(GeoAnnotator.currUserId!=="0"&&GeoAnnotator.currGroupId!=="0"){if(g.hoverFeature!==null){var h=g.hoverFeature.attributes.id;if(GeoAnnotator.ContributePanelCtrl.containerPanel.collapsed===false){g.contextMenu.add({id:"add-footprint-ctx",iconCls:"add-footprint-icon",text:"Add to reference",scope:g,handler:function(){var j=GeoAnnotator.MapPanelCtrl;if(j.hoverFeature!==null){j.addFeatureToReference(j.hoverFeature)}}})}if(g.hoverFeature.attributes.id.indexOf("-")===0){g.contextMenu.add({id:"delete-footprint-ctx",iconCls:"delete-footprint-icon",text:"Delete",scope:g,handler:function(){var k=GeoAnnotator.MapPanelCtrl;if(k.hoverFeature!==null){var j=k.hoverFeature;k.setNavigationMode();k.deleteFeature(j)}}});g.contextMenu.add({id:"modify-footprint-ctx",iconCls:"modify-footprint-icon",text:"Modify",scope:g,handler:function(){var j=GeoAnnotator.MapPanelCtrl;if(j.hoverFeature!==null){j.setModifyMode();j.modifyNewFootprintControl.selectControl.select(j.hoverFeature)}}})}}else{g.contextMenu.add({id:"draw-footprint-ctx",iconCls:"draw-footprint-icon",text:"Draw a footprint",scope:g,handler:function(){var j=GeoAnnotator.MapPanelCtrl;j.setDrawMode()}})}if(g.contextMenu.items.length>0){g.contextMenu.showAt(f.getXY())}f.preventDefault()}});c.footprintStyle=new OpenLayers.StyleMap({"default":new OpenLayers.Style({strokeColor:"#EE4F44",strokeOpacity:1,strokeWidth:2,fillColor:"#EE4F44",fillOpacity:0}),select:new OpenLayers.Style({fillColor:"#FFCC33",fillOpacity:0.3,strokeColor:"#blue",strokeOpacity:1,strokeWidth:4,cursor:"pointer"}),hover:new OpenLayers.Style({fillColor:"#FFCC33",fillOpacity:0.5,strokeColor:"#EE4F44",strokeOpacity:1,strokeWidth:3,cursor:"pointer"})});var e=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);e.strokeColor="#00FF00";e.strokeOpacity=1;e.strokeWidth=2;e.fillColor="#D4DDC3";e.fillOpacity=0;e.strokeDashstyle="dashdot";var a=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);a.strokeColor="#00FF00";a.strokeOpacity=1;a.strokeWidth=3;a.fillColor="#D4DDC3";a.fillOpacity=0.5;a.strokeDashstyle="dashdot";a.cursor="pointer";var d=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style.select);d.strokeColor="blue";d.strokeOpacity=1;d.strokeWidth=3;d.fillColor="#D4DDC3";d.fillOpacity=0.5;d.strokeDashstyle="dashdot";d.cursor="pointer";c.newfootprintStyle=new OpenLayers.StyleMap({"default":e,select:d,hover:a});c.loadToolbar()},update:function(c){var b=GeoAnnotator.MapPanelCtrl;var a={};if(c&&c!==null&&c!=={}){a=c}else{if(GeoAnnotator.currUserId!="0"){a.userId=GeoAnnotator.currUserId}if(GeoAnnotator.currCommentId!="0"){a.commentId=GeoAnnotator.currCommentId}if(GeoAnnotator.currIssueId!="0"){a.issueId=GeoAnnotator.currIssueId}if(GeoAnnotator.currGroupId!="0"){a.groupId=GeoAnnotator.currGroupId}}Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Map/",success:b.onLoadMapInfoSuccess,failure:b.onLoadMapInfoFailure,params:a});b.loadToolbar()},onLoadMapInfoSuccess:function(b){var a=GeoAnnotator.MapPanelCtrl;a.currMapInfo=Ext.util.JSON.decode(b.responseText);if(a.currMapInfo!=null){if(a.currMapInfo.type=="group"){a.loadMap();a.loadFootprints();a.loadControls();a.drawCurrPageBox();if(GeoAnnotator.currIssueId!="0"||GeoAnnotator.currCommentId!="0"){a.update()}}else{a.updateMap()}}},onLoadMapInfoFailure:function(){alert("Failed to load map information!")},updateMap:function(){var a=GeoAnnotator.MapPanelCtrl;if(a.currMapInfo.mapString&&a.currMapInfo.mapString!=""){var l=GeoAnnotator.Util.parseXML(a.currMapInfo.mapString);var h=null;if(l.getElementsByTagName("contextmap").length>0){h=l.getElementsByTagName("contextmap").item(0)}else{return}var j=h.getAttribute("zoom")||"";var d=h.getAttribute("centerX")||"";var c=h.getAttribute("centerY")||"";var k=h.getAttribute("extent")||"";var f=h.getAttribute("layoutId")||"";var b=h.getAttribute("pageId")||"";if(k!==""){GeoAnnotator.currLayoutExtent=k}if(f!==""){GeoAnnotator.currLayoutId=f}if(b!==""){GeoAnnotator.currPageId=b}if(k&&k!==""){a.map.zoomToExtent(OpenLayers.Bounds.fromString(k))}else{if(j!==""&&d!==""&&c!==""){a.map.setCenter(new OpenLayers.LonLat(d,c),parseInt(j))}}var g=a.map.getCenter().toShortString();Ext.Ajax.request({url:GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/",method:"GET",params:{mode:a.currPageViewMode,coords:g},success:function(p){var i=GeoAnnotator.MapPanelCtrl;currPageInfo=Ext.util.JSON.decode(p.responseText);if(currPageInfo!=null&&currPageInfo.status==="success"){GeoAnnotator.currLayoutId=currPageInfo.layout_id;GeoAnnotator.currPageId=currPageInfo.number;var q=i.containerPanel.getTopToolbar();q.items.get("pageNav-group").items.get("pageNumber-txt").setValue(GeoAnnotator.currPageId);i.currPageBox.destroyFeatures();var o=OpenLayers.Bounds.fromString(currPageInfo.extent);i.currPageBox.addFeatures(new OpenLayers.Feature.Vector(o.toGeometry()))}},failure:function(){alert("failed to get page number")}})}a.setNavigationMode();if(GeoAnnotator.currFootprintId!="0"){a.moveToFeature(GeoAnnotator.currFootprintId)}else{if(a.currMapInfo.footprints!=null){for(var e=0;e<a.currMapInfo.footprints.length;e++){var n=a.currMapInfo.footprints[e];for(var e=0;e<a.annotationVectors.features.length;e++){var m=a.annotationVectors.features[e];if(m.attributes.id===n.id){a.selectFootprintControl.highlight(m)}else{a.selectFootprintControl.unhighlight(m)}}}}}},loadMap:function(){var g=GeoAnnotator.MapPanelCtrl;var d=GeoAnnotator.Util.parseXML(g.currMapInfo.mapString);var h=null;if(d.getElementsByTagName("contextmap").length>0){h=d.getElementsByTagName("contextmap").item(0)}else{return}var a=h.getAttribute("zoom");var q=h.getAttribute("centerX");var o=h.getAttribute("centerY");var u=h.getAttribute("extent")||"";var m=h.getAttribute("layoutId")||"";var v=h.getAttribute("pageId")||"";if(u!==""){GeoAnnotator.currLayoutExtent=u}if(m!==""){GeoAnnotator.currLayoutId=m}if(v!==""){GeoAnnotator.currPageId=v}var G=new Object();if(h.getElementsByTagName("options").length>0){var w=h.getElementsByTagName("options").item(0);var x=w.getElementsByTagName("option");for(var D=0;D<x.length;D++){var k=x.item(D);var J=k.getAttribute("key");var B=k.getAttribute("value");if(B.toLowerCase()=="true"){B=true}if(B.toLowerCase()=="false"){B=false}switch(J){case"projection":G[J]=new OpenLayers.Projection(B);break;case"displayProjection":G.displayProjection=new OpenLayers.Projection(B);break;case"minExtent":G[J]=OpenLayers.Bounds.fromString(B);break;case"maxExtent":G[J]=OpenLayers.Bounds.fromString(B);break;case"numZoomLevels":G[J]=parseInt(B);default:G[J]=B}}}if(h.getElementsByTagName("layers").length>0){if(g.navigationControl&&g.navigationControl.events){g.navigationControl.events.un({activate:g.onNavigationActivate,deactivate:g.onNavigationDeactivate,scope:g})}g.map.destroy();G.controls=[];g.buildMap(this.mapDiv,G);g.currLayers.length=0;var y=h.getElementsByTagName("layers").item(0);var A=y.getElementsByTagName("layer");for(var D=0;D<A.length;D++){var z=A.item(D);var I=z.getAttribute("name");var e=z.getAttribute("type");var c=new Object();if(z.getElementsByTagName("options").length>0){var w=z.getElementsByTagName("options").item(0);var x=w.getElementsByTagName("option");for(var C=0;C<x.length;C++){var k=x.item(C);var J=k.getAttribute("key");var B=k.getAttribute("value");if(B.toLowerCase()=="true"){c[J]=true}else{if(B.toLowerCase()=="false"){c[J]=false}else{if(J=="minZoomLevel"||J=="maxZoomLevel"){c[J]=parseInt(B)}else{c[J]=B}}}}}var E;switch(e){case"Google":if(c.type&&typeof c.type=="string"){c.type=g.getGMapType(c.type)}E=new OpenLayers.Layer.Google(I,c);break;case"WMS":var n=z.getElementsByTagName("url").item(0).childNodes[0].nodeValue;var t=new Object();if(z.getElementsByTagName("params").length>0){var l=z.getElementsByTagName("params").item(0);var p=l.getElementsByTagName("param");for(var C=0;C<p.length;C++){var H=p.item(C);t[H.getAttribute("key")]=H.getAttribute("value")}}E=new OpenLayers.Layer.WMS(I,n,t,c);break;case"GML":var n=z.getElementsByTagName("url").item(0).childNodes[0].nodeValue;if(c.format=="OpenLayers.Format.KML"){c.format=OpenLayers.Format.KML}var f=new Object();if(z.getElementsByTagName("formatOptions").length>0){var r=z.getElementsByTagName("formatOptions").item(0);var s=r.getElementsByTagName("formatOption");for(var C=0;C<s.length;C++){var F=s.item(C);f[F.getAttribute("key")]=F.getAttribute("value")}}c.formatOptions=f;E=new OpenLayers.Layer.GML(I,n,c);break;default:break}if(E!=undefined&&E!=null){if(c.visibility==true&&c.isBaseLayer==true){g.baseLayer=E}g.currLayers.push(E)}}g.map.addLayers(g.currLayers);g.map.setBaseLayer(g.baseLayer);var b=OpenLayers.Util.extend({},OpenLayers.Feature.Vector.style["default"]);b.fillOpacity=0;b.graphicOpacity=1;b.strokeWidth=3;g.currPageBox=new OpenLayers.Layer.Vector("Current Page",{style:b});g.map.addLayer(g.currPageBox);g.map.setCenter(new OpenLayers.LonLat(q,o),parseInt(a));if(u&&u!==""){g.map.zoomToExtent(OpenLayers.Bounds.fromString(u))}}},loadFootprints:function(){var f=GeoAnnotator.MapPanelCtrl;var e=null;var d=new OpenLayers.Format.WKT();f.annotationVectors=new OpenLayers.Layer.Vector("Annotation Footprints",{styleMap:f.footprintStyle,displayInLayerSwitcher:true});f.map.addLayer(this.annotationVectors);if(f.currMapInfo.footprints!=null){for(var c=0;c<f.currMapInfo.footprints.length;c++){var a=f.currMapInfo.footprints[c];var b=d.read(a.shape);b.attributes={};b.attributes.id=a.id;b.attributes.groupId=a.groupId;if(a.refCount!=null){b.attributes.pointRadius=a.refCount*5;b.attributes.refCount=a.refCount}if(a.alias!=null){b.attributes.alias=a.alias}f.annotationVectors.addFeatures([b])}}f.newFootprintVectors=new OpenLayers.Layer.Vector("New Footprints",{styleMap:f.newfootprintStyle,displayInLayerSwitcher:false});for(var c=0;c<GeoAnnotator.ContributePanelCtrl.newFootprints.length;c++){if(GeoAnnotator.ContributePanelCtrl.newFootprints[c].attributes.groupId==GeoAnnotator.currGroupId){f.newFootprintVectors.addFeatures([GeoAnnotator.ContributePanelCtrl.newFootprints[c]])}}f.map.addLayer(this.newFootprintVectors)},loadControls:function(){var a=GeoAnnotator.MapPanelCtrl;a.map.addControl(new OpenLayers.Control.PanZoomBar());a.map.addControl(new OpenLayers.Control.LayerSwitcher());a.map.addControl(new OpenLayers.Control.Attribution());a.navigationControl=new OpenLayers.Control.Navigation();a.map.addControl(a.navigationControl);a.selectFootprintControl=new OpenLayers.Control.SelectFeature([a.annotationVectors,a.newFootprintVectors],{clickout:true,toggle:false,multiple:false,hover:false,callbacks:{over:a.onOverFeature,out:a.onOutFeature,click:a.onClickFeature}});a.map.addControl(a.selectFootprintControl);a.modifyNewFootprintControl=new OpenLayers.Control.ModifyFeature(a.newFootprintVectors);a.newFootprintVectors.events.register("afterfeaturemodified",a.newFootprintVectors,a.onModificationEnd);a.map.addControl(a.modifyNewFootprintControl);a.drawFootprintControl=new OpenLayers.Control.DrawFeature(a.newFootprintVectors,OpenLayers.Handler.Polygon,{featureAdded:function(b){b.state=OpenLayers.State.INSERT;a.onFeatureAdded(b)}});a.map.addControl(a.drawFootprintControl);a.setNavigationMode()},loadToolbar:function(){var a=GeoAnnotator.MapPanelCtrl;var b=a.containerPanel.getTopToolbar();b.items.each(function(e,c,d){e.destroy()});if(GeoAnnotator.currGroupId==="0"){return}b.add({xtype:"buttongroup",columns:3,title:"Display Mode",items:[{id:"showOverview-btn",handler:function(){var c=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutExtent&&GeoAnnotator.currLayoutExtent!==""){c.map.zoomToExtent(OpenLayers.Bounds.fromString(GeoAnnotator.currLayoutExtent))}},iconCls:"overview-btn-icon",scale:"medium",tooltip:{title:"Show Overview",text:"Show the whole manuscript in an overview"}},{id:"showSinglePage-btn",iconCls:"singlepage-btn-icon",scale:"medium",tooltip:{title:"Single Pages",text:"Show the current single page of the manuscript"},handler:function(){a.currPageViewMode="single";a.zoomToCurrPage()}},{id:"showFacingPages-btn",iconCls:"facingpages-btn-icon",scale:"medium",tooltip:{title:"Facing Pages",text:"Show the current facing pages of the manuscript"},handler:function(c,d){if(d){a.currPageViewMode="facing";a.zoomToCurrPage()}}}]});b.add({xtype:"buttongroup",title:"Page Navigation",id:"pageNav-group",columns:3,defaults:{scale:"medium"},items:[{id:"showPrevPage-btn",handler:a.zoomToPrevPage,iconCls:"prevpage-btn-icon",tooltip:{title:"Prev Page",text:"Go the the view of previous page"}},new Ext.form.TextField({id:"pageNumber-txt",width:75,emptyText:"",enableKeyEvents:true,listeners:{keydown:function(c,d){if(d.getKey()===13){GeoAnnotator.MapPanelCtrl.jumpToPage()}}}}),{id:"showNextPage-btn",handler:a.zoomToNextPage,iconCls:"nextpage-btn-icon",tooltip:{title:"Next Page",text:"Go the the view of next page"}}]});if(GeoAnnotator.currUserId!=="0"){b.add({xtype:"buttongroup",id:"toolbox-group",title:"Annotation",defaults:{scale:"medium"},items:[{id:"contribute-btn",iconCls:"group-contribute-tab",pressed:false,enableToggle:true,toggleHandler:function(c,d){if(d){GeoAnnotator.ContributePanelCtrl.containerPanel.expand(false)}else{GeoAnnotator.ContributePanelCtrl.containerPanel.collapse(false)}},text:"Contribute",tooltip:{title:"Contribute",text:"Contribute to the current manuscript"}},{id:"manage-btn",iconCls:"group-manage-tab",pressed:false,enableToggle:true,toggleHandler:function(c,d){if(d){GeoAnnotator.ManageWindowCtrl.containerWindow.show()}else{GeoAnnotator.ManageWindowCtrl.containerWindow.hide()}},text:"Manage",tooltip:{title:"Manage",text:"Manage the annotations"}}]})}b.doLayout()},getGMapType:function(b){var a;switch(b){case"G_NORMAL_MAP":a=G_NORMAL_MAP;a.toString=function(){return"G_NORMAL_MAP"};break;case"G_SATELLITE_MAP":a=G_SATELLITE_MAP;a.toString=function(){return"G_SATELLITE_MAP"};break;case"G_HYBRID_MAP":a=G_HYBRID_MAP;a.toString=function(){return"G_HYBRID_MAP"};break;case"G_PHYSICAL_MAP":a=G_PHYSICAL_MAP;a.toString=function(){return"G_PHYSICAL_MAP"};break;case"G_CUSTOM_CENTREIMAGERY_MAP":var c=new GTileLayer(new GCopyrightCollection(""),0,19,{tileUrlTemplate:"http://www.apps.geovista.psu.edu/tilecache/tilecache.py/1.0.0/centreimageryjpeg/{Z}/{X}/{Y}.jpg?type=google",isPng:false});a=new GMapType([c,G_HYBRID_MAP.getTileLayers()[1]],new GMercatorProjection(20),"Centre Imagery with Google Labels",{shortName:"CIL"});a.toString=function(){return"G_CUSTOM_CENTREIMAGERY_MAP"};break;default:a=G_NORMAL_MAP;a.toString=function(){return"G_NORMAL_MAP"};break}return a},setNavigationMode:function(){var a=GeoAnnotator.MapPanelCtrl;if(a.navigationControl){a.navigationControl.activate()}if(a.selectFootprintControl){a.selectFootprintControl.activate()}if(a.drawFootprintControl){a.drawFootprintControl.deactivate()}if(a.modifyNewFootprintControl){a.modifyNewFootprintControl.deactivate()}},setDrawMode:function(){var a=GeoAnnotator.MapPanelCtrl;if(a.navigationControl){a.navigationControl.deactivate()}if(a.selectFootprintControl){a.selectFootprintControl.deactivate()}if(a.drawFootprintControl){a.drawFootprintControl.activate()}if(a.modifyNewFootprintControl){a.modifyNewFootprintControl.deactivate()}},setModifyMode:function(){var a=GeoAnnotator.MapPanelCtrl;if(a.navigationControl){a.navigationControl.activate()}if(a.selectFootprintControl){a.selectFootprintControl.deactivate()}if(a.drawFootprintControl){a.drawFootprintControl.deactivate()}if(a.modifyNewFootprintControl){a.modifyNewFootprintControl.activate()}},buildMap:function(c,a){var b=GeoAnnotator.MapPanelCtrl;b.map=new OpenLayers.Map(c,a)},addFeatureToReference:function(b){var a="[FP"+b.attributes.id+"]";var c=b.attributes.id;GeoAnnotator.ContributePanelCtrl.addFootprintToReference(c,a)},removeFeatureFromReference:function(a){GeoAnnotator.ContributePanelCtrl.removeFootprintFromReference(a.attributes.id)},deleteFeature:function(b){var c=GeoAnnotator.MapPanelCtrl;for(var a=0;a<GeoAnnotator.ContributePanelCtrl.newFootprints.length;a++){if(GeoAnnotator.ContributePanelCtrl.newFootprints[a].attributes.id==b.attributes.id){GeoAnnotator.ContributePanelCtrl.removeFootprintFromReference(b.attributes.id);GeoAnnotator.ContributePanelCtrl.newFootprints.splice(a,1);c.newFootprintVectors.destroyFeatures([b],{silent:true});c.hoverFeature=null;return}}},onModificationEnd:function(b,a){var c=GeoAnnotator.MapPanelCtrl;c.setNavigationMode();c.hoverFeature=null},addSelectedFeaturesToReferences:function(){var d=GeoAnnotator.MapPanelCtrl;var c=d.annotationVectors;for(var b=0;b<c.selectedFeatures.length;b++){var a=c.selectedFeatures[b];d.addFeatureToReference(a)}},showAnnotationListWindow:function(){var a=GeoAnnotator.MapPanelCtrl;if(!a.annotationListWindow){a.annotationListStore=new Ext.data.JsonStore({root:"annotations",totalProperty:"totalCount",idProperty:"id",fields:["id","userName",{name:"timeCreated",type:"date"},"excerpt"],proxy:new Ext.data.HttpProxy({url:GeoAnnotator.baseUrl+"Annotations/"}),baseParams:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,start:0,limit:10}});var b=new Ext.XTemplate('<tpl for=".">','<div class="list-item">','<h3><span>{timeCreated:date("M d, Y")}</span>',"{userName} says:</h3>","<p>{excerpt}</p>","</div></tpl>");a.annotationListDataView=new Ext.DataView({tpl:b,store:a.annotationListStore,itemSelector:"div.list-item",multiSelect:true,selectedClass:"list-item-selected",overClass:"list-item-over",emptyText:"No Annotations"});a.annotationListDataView.on("click",a.onAnnotationListItemClick);a.annotationListWindow=new Ext.Window({layout:"fit",width:450,autoHeight:true,closeAction:"hide",plain:true,title:"Annotation List",autoScroll:true,items:[a.annotationListDataView],tbar:new Ext.PagingToolbar({store:a.annotationListStore,pageSize:10,displayInfo:true,displayMsg:"Annotations {0} - {1} of {2}",emptyMsg:"No annotations to display"}),})}a.annotationListWindow.show()},moveToFeature:function(f){var c=GeoAnnotator.MapPanelCtrl;for(var b=0;b<c.annotationVectors.features.length;b++){var a=c.annotationVectors.features[b];if(a.attributes.id===f){var e=a.geometry.getCentroid().x;var d=a.geometry.getCentroid().y;c.map.panTo(new OpenLayers.LonLat(e,d));c.selectFootprintControl.unselectAll();c.selectFootprintControl.select(a);return}}},onFeatureAdded:function(a){var b=GeoAnnotator.MapPanelCtrl;a.attributes.id="-"+GeoAnnotator.ContributePanelCtrl.newFootprints.length;a.attributes.groupId=GeoAnnotator.currGroupId;a.attributes.alias="new footprint";GeoAnnotator.ContributePanelCtrl.newFootprints.push(a);if(GeoAnnotator.ContributePanelCtrl.containerPanel.collapsed===false){b.addFeatureToReference(a)}b.setNavigationMode()},onClickFeature:function(a){if(a){var b=GeoAnnotator.MapPanelCtrl;if(a.attributes.id.indexOf("-")===0){return}GeoAnnotator.currFootprintId=a.attributes.id;if(parseInt(a.attributes.refCount)===1){Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotations/",params:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,footprintId:GeoAnnotator.currFootprintId,start:0,limit:1},success:function(e){var c=Ext.util.JSON.decode(e.responseText);if(c.totalCount>0){var f=c.annotations[0].id;var d=c.annotations[0].type;if(d=="issue"){GeoAnnotator.currIssueId=f;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=f}GeoAnnotator.AnnotationInfoPanelCtrl.update()}},failure:function(){alert("failed!")}})}else{b.showAnnotationListWindow();b.annotationListStore.removeAll();b.annotationListStore.baseParams={userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,footprintId:GeoAnnotator.currFootprintId};b.annotationListStore.load({params:{start:0,limit:10}});b.selectFootprintControl.clickFeature(a)}}},onOverFeature:function(a){var b=GeoAnnotator.MapPanelCtrl;a.layer.drawFeature(a,"hover");b.hoverFeature=a},onOutFeature:function(a){var b=GeoAnnotator.MapPanelCtrl;b.hoverFeature=null;if(b.contextMenu!==null){b.contextMenu.hide()}if(OpenLayers.Util.indexOf(this.layer.selectedFeatures,a)==-1){a.layer.drawFeature(a,"default")}else{a.layer.drawFeature(a,"select")}},onAnnotationListItemClick:function(f,a,c,d){var g=f.getRecord(c).get("id");var b=f.getRecord(c).get("type");if(b=="issue"){GeoAnnotator.currIssueId=g;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=g}GeoAnnotator.AnnotationInfoPanelCtrl.update()},jumpToPage:function(){var b=GeoAnnotator.MapPanelCtrl;var c=b.containerPanel.getTopToolbar();var a=c.items.get("pageNav-group").items.get("pageNumber-txt").getValue();if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){if(a&&a!==""){b.zoomToPage(a)}else{b.zoomToFirstPage()}}else{alert("currLayoutId is not defined or is empty!")}},zoomToPage:function(a){var b=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){if(a&&a!==""){Ext.Ajax.request({url:GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/",params:{mode:b.currPageViewMode,page:a},method:"GET",success:b.onLoadPageInfoSuccess,failure:b.onLoadPageInfoFailure,})}}else{alert("currLayoutId is not defined or is empty!")}},zoomToCurrPage:function(){var a=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currPageId&&GeoAnnotator.currPageId!==""){a.zoomToPage(GeoAnnotator.currPageId)}else{a.zoomToFirstPage()}},zoomToFirstPage:function(){var a=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){Ext.Ajax.request({url:GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/first/",method:"GET",params:{mode:a.currPageViewMode},success:a.onLoadPageInfoSuccess,failure:a.onLoadPageInfoFailure,})}else{alert("currLayoutId is not defined or is empty!")}},zoomToLastPage:function(){var a=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){Ext.Ajax.request({url:GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/last/",method:"GET",params:{mode:a.currPageViewMode},success:a.onLoadPageInfoSuccess,failure:a.onLoadPageInfoFailure,})}else{alert("currLayoutId is not defined or is empty!")}},zoomToPrevPage:function(){var a=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){if(GeoAnnotator.currPageId&&GeoAnnotator.currPageId!==""){Ext.Ajax.request({url:GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/"+GeoAnnotator.currPageId+"/prev/",method:"GET",params:{mode:a.currPageViewMode},success:a.onLoadPageInfoSuccess,failure:a.onLoadPageInfoFailure,})}else{a.zoomToFirstPage()}}else{alert("currLayoutId is not defined or is empty!")}},zoomToNextPage:function(){var a=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){if(GeoAnnotator.currPageId&&GeoAnnotator.currPageId!==""){Ext.Ajax.request({url:GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/"+GeoAnnotator.currPageId+"/next/",method:"GET",params:{mode:a.currPageViewMode},success:a.onLoadPageInfoSuccess,failure:a.onLoadPageInfoFailure,})}else{a.zoomToFirstPage()}}else{alert("currLayoutId is not defined or is empty!")}},onLoadPageInfoSuccess:function(c){var a=GeoAnnotator.MapPanelCtrl;currPageInfo=Ext.util.JSON.decode(c.responseText);if(currPageInfo!=null&&currPageInfo.status==="success"){GeoAnnotator.currLayoutId=currPageInfo.layout_id;GeoAnnotator.currPageId=currPageInfo.number;var d=a.containerPanel.getTopToolbar();d.items.get("pageNav-group").items.get("pageNumber-txt").setValue(GeoAnnotator.currPageId);a.currPageBox.destroyFeatures();var b=OpenLayers.Bounds.fromString(currPageInfo.extent);a.currPageBox.addFeatures(new OpenLayers.Feature.Vector(b.toGeometry()));a.map.zoomToExtent(b)}},onLoadPageInfoFailure:function(){alert("Failed to load page information!")},drawCurrPageBox:function(){var b=GeoAnnotator.MapPanelCtrl;if(GeoAnnotator.currLayoutId&&GeoAnnotator.currLayoutId!==""){var a="";if(GeoAnnotator.currPageId&&GeoAnnotator.currPageId!==""){a=GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/"}else{a=GeoAnnotator.baseUrl+"layout/"+GeoAnnotator.currLayoutId+"/page/first/"}Ext.Ajax.request({url:a,method:"GET",params:{mode:b.currPageViewMode,page:GeoAnnotator.currPageId},success:function(e){currPageInfo=Ext.util.JSON.decode(e.responseText);if(currPageInfo!=null&&currPageInfo.status==="success"){var c=GeoAnnotator.MapPanelCtrl;GeoAnnotator.currLayoutId=currPageInfo.layout_id;GeoAnnotator.currPageId=currPageInfo.number;var f=c.containerPanel.getTopToolbar();f.items.get("pageNav-group").items.get("pageNumber-txt").setValue(GeoAnnotator.currPageId);c.currPageBox.destroyFeatures();var d=OpenLayers.Bounds.fromString(currPageInfo.extent);c.currPageBox.addFeatures(new OpenLayers.Feature.Vector(d.toGeometry()))}},failure:b.onLoadPageInfoFailure,})}else{alert("currLayoutId is not defined or is empty!")}}};GeoAnnotator.TimelinePanelCtrl={containerPanel:null,timelineData:{},startDate:null,endDate:null,earliestDate:null,latestDate:null,totalCount:0,mode:"month",unit:"day",timelinePanel:null,annotationListWindow:null,annotationListStore:null,register:function(a){this.containerPanel=a},init:function(){thisCtrl=GeoAnnotator.TimelinePanelCtrl;thisCtrl.timelineData=new Ext.data.ArrayStore({fields:["date","count","label"]});thisCtrl.timelinePanel=new Ext.Panel({tbar:[{id:"timeline-earliest-btn",iconCls:"timeline-earliest-icon",handler:thisCtrl.moveToEarliest},"-",{id:"timeline-previous-btn",iconCls:"timeline-previous-icon",handler:thisCtrl.moveToPrev},"-",{text:"Day",id:"timeline-day-btn",enableToggle:true,pressed:false,toggleGroup:"timeline-mode",handler:function(b,a){thisCtrl=GeoAnnotator.TimelinePanelCtrl;thisCtrl.mode="day";thisCtrl.moveToNow();b.toggle(true)}},"-",{text:"Week",id:"timeline-week-btn",enableToggle:true,pressed:false,toggleGroup:"timeline-mode",handler:function(b,a){thisCtrl=GeoAnnotator.TimelinePanelCtrl;thisCtrl.mode="week";thisCtrl.moveToNow();b.toggle(true)}},"-",{text:"Month",id:"timeline-month-btn",enableToggle:true,pressed:true,toggleGroup:"timeline-mode",handler:function(b,a){thisCtrl=GeoAnnotator.TimelinePanelCtrl;thisCtrl.mode="month";thisCtrl.moveToNow();b.toggle(true)}},"-",{text:"Year",id:"timeline-year-btn",enableToggle:true,pressed:false,toggleGroup:"timeline-mode",handler:function(b,a){thisCtrl=GeoAnnotator.TimelinePanelCtrl;thisCtrl.mode="year";thisCtrl.moveToNow();b.toggle(true)}},"-",{id:"timeline-next-btn",iconCls:"timeline-next-icon",handler:thisCtrl.moveToNext},"-",{id:"timeline-latest-btn",iconCls:"timeline-latest-icon",handler:thisCtrl.moveToLatest},"->",{text:"Now",id:"timeline-now-btn",iconCls:"timeline-now-icon",handler:thisCtrl.moveToNow}],items:{xtype:"columnchart",store:thisCtrl.timelineData,yField:"count",url:"./lib/ext-3.2.1/resources/charts.swf",xField:"label",xAxis:new Ext.chart.CategoryAxis({title:"Time"}),yAxis:new Ext.chart.NumericAxis({title:"Count"}),tipRenderer:function(d,a,b,c){return a.data.count+" annotations"},extraStyle:{xAxis:{}},listeners:{itemclick:thisCtrl.onTimelineItemClick}}});thisCtrl.containerPanel.add(thisCtrl.timelinePanel);thisCtrl.containerPanel.doLayout();thisCtrl.containerPanel.on("collapse",function(){GeoAnnotator.MapPanelCtrl.map.updateSize();GeoAnnotator.ContainerTBCtrl.containerTB.get("timeline-btn").toggle(false)});thisCtrl.containerPanel.on("expand",function(){GeoAnnotator.MapPanelCtrl.map.updateSize();GeoAnnotator.ContainerTBCtrl.containerTB.get("timeline-btn").toggle(true)});thisCtrl.containerPanel.collapse(false)},loadTimelineData:function(b){var a=GeoAnnotator.TimelinePanelCtrl;var c=[];switch(a.mode){case"year":c=a.generateYearData(b);break;case"month":c=a.generateMonthData(b);break;case"week":c=a.generateWeekData(b);break;case"day":c=a.generateDayData(b);break;default:alert("not supported display mode!")}a.timelineData.loadData(c)},generateYearData:function(m){var b=GeoAnnotator.TimelinePanelCtrl;var d=[];var n=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");if(b.startDate){var a=new Date(b.startDate.getFullYear(),b.startDate.getMonth());for(var e=0;e<12;e++){a.setMonth(a.getMonth()+1);var f=a.getMonth();var h=a.getFullYear();var l=n[f]+" "+h;var g=[a.toGMTString(),0,l];for(var c=0;c<m.length;c++){var k=new Date(m[c].month);if(a.toGMTString()===k.toGMTString()){g[1]=parseInt(m[c].count);break}}d.push(g)}}return d},generateMonthData:function(n){var b=GeoAnnotator.TimelinePanelCtrl;var e=[];var o=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");if(b.startDate){var a=new Date(b.startDate.getFullYear(),b.startDate.getMonth(),b.startDate.getDate());for(var f=0;f<30;f++){a.setDate(a.getDate()+1);var g=a.getMonth();var k=a.getDate();var d="";if(k==1||k==21||k==31){d="st"}else{if(k==2||k==22){d="nd"}else{if(k==3||k==23){d="rd"}else{d="th"}}}var m="";if(k==1){m=o[g]+" "+k}else{m=k}var h=[a.toGMTString(),0,m];for(var c=0;c<n.length;c++){var l=new Date(n[c].day);if(a.toGMTString()==l.toGMTString()){h[1]=parseInt(n[c].count);break}}e.push(h)}}return e},generateWeekData:function(n){var b=GeoAnnotator.TimelinePanelCtrl;var e=[];var o=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");if(b.startDate){var a=new Date(b.startDate.getFullYear(),b.startDate.getMonth(),b.startDate.getDate());for(var f=0;f<7;f++){a.setDate(a.getDate()+1);var g=a.getMonth();var k=a.getDate();var d="";if(k==1||k==21||k==31){d="st"}else{if(k==2||k==22){d="nd"}else{if(k==3||k==23){d="rd"}else{d="th"}}}var m=o[g]+" "+k+d;var h=[a.toGMTString(),0,m];for(var c=0;c<n.length;c++){var l=new Date(n[c].day);if(a.toGMTString()===l.toGMTString()){h[1]=parseInt(n[c].count);break}}e.push(h)}}return e},generateDayData:function(p){var d=GeoAnnotator.TimelinePanelCtrl;var g=[];if(d.startDate){var c=new Date(d.startDate.getFullYear(),d.startDate.getMonth(),d.startDate.getDate(),d.startDate.getHours());for(var h=0;h<24;h++){c.setHours(c.getHours()+1);var k=c.getMonth();var m=c.getDate();var e=c.getHours();var b="";if(m==1||m==21||m==31){b="st"}else{if(m==2||m==22){b="nd"}else{if(m==3||m==23){b="rd"}else{b="th"}}}var a="";if(e==0){e=12;a="AM"}else{if(e>0&&e<12){a="AM"}else{if(e==12){a="PM"}else{e=e-12;a="PM"}}}var o="";if(h==0||(e==12&&a=="AM")){o=(k+1)+"/"+m+" "+e+" "+a}else{o=e+" "+a}var l=[c.toGMTString(),0,o];for(var f=0;f<p.length;f++){var n=new Date(p[f].hour);if(c.toGMTString()===n.toGMTString()){l[1]=parseInt(p[f].count);break}}g.push(l)}}return g},moveToEarliest:function(){var a=GeoAnnotator.TimelinePanelCtrl;if(a.earliestDate!==null){a.startDate=new Date(a.earliestDate);a.calcEndDate();a.update()}a.update()},moveToPrev:function(){var a=GeoAnnotator.TimelinePanelCtrl;a.endDate=new Date(a.startDate);a.calcStartDate();a.update()},moveToNext:function(){var a=GeoAnnotator.TimelinePanelCtrl;a.startDate=new Date(a.endDate);a.calcEndDate();a.update()},moveToLatest:function(){var a=GeoAnnotator.TimelinePanelCtrl;if(a.latestDate!==null){a.endDate=new Date(a.latestDate);a.calcStartDate();a.update()}},moveToNow:function(){var a=GeoAnnotator.TimelinePanelCtrl;a.endDate=new Date();a.calcStartDate();a.update()},calcStartDate:function(){var a=GeoAnnotator.TimelinePanelCtrl;if(a.endDate!==null){a.startDate=new Date(a.endDate);switch(a.mode){case"year":a.unit="month";a.startDate.setFullYear(a.endDate.getFullYear()-1);break;case"month":a.unit="day";a.startDate.setMonth(a.endDate.getMonth()-1);break;case"week":a.unit="day";a.startDate.setDate(a.endDate.getDate()-7);break;case"day":a.unit="hour";a.startDate.setDate(a.endDate.getDate()-1);break;default:alert("not supported display mode!")}}},calcEndDate:function(){var a=GeoAnnotator.TimelinePanelCtrl;if(a.startDate!==null){a.endDate=new Date(a.startDate);switch(a.mode){case"year":a.unit="month";a.endDate.setFullYear(a.startDate.getFullYear()+1);break;case"month":a.unit="day";a.endDate.setMonth(a.startDate.getMonth()+1);break;case"week":a.unit="day";a.endDate.setDate(a.startDate.getDate()+7);break;case"day":a.unit="hour";a.endDate.setDate(a.startDate.getDate()+1);break;default:alert("not supported display mode!")}}},update:function(){var a=GeoAnnotator.TimelinePanelCtrl;if(GeoAnnotator.currGroupId==="0"){return}if(a.startDate===null||a.endDate===null){a.moveToNow()}else{Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Timeline/",success:a.onLoadTimelineInfoSuccess,failure:function(){alert("failed to load timeline info!")},params:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,unit:a.unit,startDate:a.startDate.toGMTString(),endDate:a.endDate.toGMTString()}})}},onLoadTimelineInfoSuccess:function(c){var b=GeoAnnotator.TimelinePanelCtrl;var a=Ext.util.JSON.decode(c.responseText);if(a.earliestDate){b.earliestDate=new Date(a.earliestDate)}if(a.latestDate){b.latestDate=new Date(a.latestDate)}if(a.totalCount){b.totalCount=parseInt(a.totalCount)}if(a.timeline){b.loadTimelineData(a.timeline)}var d=b.timelinePanel.getTopToolbar();if(b.startDate&&b.earliestDate&&b.startDate>b.earliestDate){d.items.get("timeline-earliest-btn").enable();d.items.get("timeline-previous-btn").enable()}else{d.items.get("timeline-earliest-btn").disable();d.items.get("timeline-previous-btn").disable()}if(b.endDate&&b.latestDate&&b.endDate<b.latestDate){d.items.get("timeline-latest-btn").enable();d.items.get("timeline-next-btn").enable()}else{d.items.get("timeline-latest-btn").disable();d.items.get("timeline-next-btn").disable()}},showAnnotationListWindow:function(){var a=GeoAnnotator.TimelinePanelCtrl;if(!a.annotationListWindow){a.annotationListStore=new Ext.data.JsonStore({root:"annotations",totalProperty:"totalCount",idProperty:"id",fields:["id","userName",{name:"timeCreated",type:"date"},"excerpt"],proxy:new Ext.data.HttpProxy({url:GeoAnnotator.baseUrl+"Annotations/"}),baseParams:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,start:0,limit:10}});var b=new Ext.XTemplate('<tpl for=".">','<div class="list-item">','<h3><span>{timeCreated:date("M d, Y")}</span>',"{userName} says:</h3>","<p>{excerpt}</p>","</div></tpl>");a.annotationListDataView=new Ext.DataView({tpl:b,store:a.annotationListStore,itemSelector:"div.list-item",multiSelect:true,selectedClass:"list-item-selected",overClass:"list-item-over",emptyText:"No Annotations"});a.annotationListDataView.on("click",a.onAnnotationListItemClick);a.annotationListWindow=new Ext.Window({layout:"fit",width:450,autoHeight:true,closeAction:"hide",plain:true,title:"Annotation List",autoScroll:true,items:[a.annotationListDataView],tbar:new Ext.PagingToolbar({store:a.annotationListStore,pageSize:10,displayInfo:true,displayMsg:"Annotations {0} - {1} of {2}",emptyMsg:"No annotations to display"}),})}a.annotationListWindow.show()},onAnnotationListItemClick:function(f,a,c,d){var g=f.getRecord(c).get("id");var b=f.getRecord(c).get("type");if(b=="issue"){GeoAnnotator.currIssueId=g;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=g}GeoAnnotator.AnnotationInfoPanelCtrl.update()},onTimelineItemClick:function(d){var c=GeoAnnotator.TimelinePanelCtrl;c.showAnnotationListWindow();var b=c.timelineData.getAt(d.index);var a=new Date(b.get("date"));var e=new Date(a);if(c.unit==="day"){e.setDate(a.getDate()+1)}else{if(c.unit==="month"){e.setMonth(a.getMonth()+1)}else{if(c.unit==="hour"){e.setHours(a.getHours()+1)}}}c.annotationListStore.removeAll();c.annotationListStore.baseParams={userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,startDate:a.toGMTString(),endDate:e.toGMTString()};c.annotationListStore.load({params:{start:0,limit:10}})}};GeoAnnotator.AnnotationInfoPanelCtrl={containerPanel:null,annotationInfoDisplayPanel:null,referenceSpaceTreePanel:null,annotationInfoWrapper:null,spaceTree:null,contextMenu:null,referenceSpaceTreeWindow:null,spaceTreeContainer:"reference-spaceTree",spaceTreeOrientation:"left",currAnnotationInfo:{},node_height:30,node_width:100,min_spacing:10,currentNodeStyle:{"default":{fill:"#0F4BFF",stroke:"#003DF5","fill-opacity":0.6,"stroke-width":2},hover:{fill:"#0F4BFF",stroke:"#003DF5","fill-opacity":0.8,"stroke-width":3},text:{stroke:"#fff",fill:"#fff"},blanket:{stroke:"none",fill:"#fff",opacity:0}},parentNodeStyle:{"default":{fill:"#0F4BFF",stroke:"#003DF5","fill-opacity":0.6,"stroke-width":2},hover:{fill:"#0F4BFF",stroke:"#003DF5","fill-opacity":0.8,"stroke-width":3},text:{stroke:"#fff",fill:"#fff"},blanket:{stroke:"none",fill:"#fff",opacity:0}},childNodeStyle:{"default":{fill:"#0F4BFF",stroke:"#003DF5","fill-opacity":0.6,"stroke-width":2},hover:{fill:"#0F4BFF",stroke:"#003DF5","fill-opacity":0.8,"stroke-width":3},text:{stroke:"#fff",fill:"#fff"},blanket:{stroke:"none",fill:"#fff",opacity:0}},register:function(a){this.containerPanel=a},init:function(){var b=GeoAnnotator.AnnotationInfoPanelCtrl;b.currAnnotationInfo={};commentWindow=null;b.spaceTreeContainer="reference-spaceTree";b.spaceTreeOrientation="left";if(b.containerPanel.items){b.containerPanel.removeAll(true)}var a='<div class="default-info">Here will show the details when you choose an annotation.</div>';b.annotationInfoDisplayPanel=new Ext.Panel({id:"annotationInfo-display-panel",bodyStyle:"padding:0px; border: 0px",html:a,region:"center",autoScroll:true,});var c=new Ext.Toolbar({id:"annotation-info-tbar",hidden:true,items:[{id:"annotation-bkm-btn",iconCls:"annotation-bkm-btn",iconAlign:"top",handler:b.onBookmarkClick,text:"Bookmark",tooltip:{title:"Bookmark It",text:"Save the current annotation for further reference."}},"-",{id:"reference-display-btn",text:"Threads",tooltip:{title:"Threads",text:"Show issues/annotaions as references or follow-ups of the current annotation."},iconCls:(b.spaceTreeOrientation=="right"?"reference-display-backward":"reference-display-forward"),iconAlign:"top",handler:b.onThreadClick},"-",{id:"annotation-edit-btn",text:"Edit",tooltip:{title:"Edit",text:"Modify the current annotation."},iconCls:"annotation-edit-icon",iconAlign:"top",disabled:true,handler:b.onEditClick},"-",{id:"annotation-delete-btn",text:"Delete",tooltip:{title:"Delete",text:"Delete the current annotation."},iconCls:"annotation-delete-icon",iconAlign:"top",disabled:true,handler:b.onDeleteClick}]});b.annotationInfoWrapper=new Ext.Panel({id:"annotationInfo-wrapper-panel",bodyStyle:"padding:0px; border: 0px",layout:"border",tbar:c,items:[b.annotationInfoDisplayPanel]});b.containerPanel.add(b.annotationInfoWrapper);b.containerPanel.getEl().on("contextmenu",function(e,g){var f=GeoAnnotator.AnnotationInfoPanelCtrl;if(!f.contextMenu){f.contextMenu=new Ext.menu.Menu({id:"annotation-panel-ctx",items:[]})}f.contextMenu.removeAll();if(f.currAnnotationInfo&&f.currAnnotationInfo.id){var d=GeoAnnotator.ContributePanelCtrl.contributeFormPanel.getForm().findField("newAnnotationId").getValue();if(d&&f.currAnnotationInfo.id!=d&&GeoAnnotator.ContributePanelCtrl.containerPanel.collapsed===false){f.contextMenu.add({id:"annotation-ref-ctx",iconCls:"annotation-ref-btn",handler:f.addAnnotationToReference,text:"Add to Reference"})}if(GeoAnnotator.ContributePanelCtrl.containerPanel.collapsed===true){f.contextMenu.add({id:"annotation-rpl-ctx",iconCls:"annotation-rpl-btn",handler:f.onCommentClick,text:"Quick Reply"})}f.contextMenu.add({id:"annotation-bkm-ctx",iconCls:"annotation-bkm-btn",handler:f.onBookmarkClick,text:"Bookmark It"});f.contextMenu.add({id:"reference-display-ctx",text:"Threads",iconCls:"reference-display-icon",handler:f.onThreadClick});if(f.currAnnotationInfo.userId==GeoAnnotator.currUserId&&parseInt(f.currAnnotationInfo.replies)<=0){f.contextMenu.add({id:"annotation-edit-ctx",text:"Edit",iconCls:"annotation-edit-icon",handler:f.onEditClick});f.contextMenu.add({id:"annotation-delete-ctx",text:"Delete",iconCls:"annotation-delete-icon",handler:f.onDeleteClick})}f.contextMenu.showAt(e.getXY());e.preventDefault()}});b.containerPanel.doLayout()},update:function(){var b=GeoAnnotator.AnnotationInfoPanelCtrl;var a='<div><p class="default-info">Loading Annotation Information...</p></div>';b.annotationInfoDisplayPanel.body.update(a);var c="0";if(GeoAnnotator.currCommentId!="0"){c=GeoAnnotator.currCommentId}else{if(GeoAnnotator.currIssueId){c=GeoAnnotator.currIssueId}}Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotation/",success:b.onLoadAnnotationInfoSuccess,failure:b.onLoadAnnotationInfoFailure,params:{annotationId:c,userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId}})},updateAnnotationInfoDisplayPanel:function(){var c=GeoAnnotator.AnnotationInfoPanelCtrl;var b="";if(c.currAnnotationInfo.type=="comment"){b+='<div id="annotationInfoHeader">On '+c.currAnnotationInfo.timeCreated+", <b>"+c.currAnnotationInfo.userName+"</b> says:</div>"}else{b+='<div id="annotationInfoHeader"><b>Issue:</b></div>'}var f=c.parseAnnotationContent(c.currAnnotationInfo.content);b+='<div id="annotationInfoContent">'+f+"</div>";c.annotationInfoDisplayPanel.body.update(b);ref_links=Ext.query(".ref-link");for(var a=0;a<ref_links.length;a++){var e=Ext.get(ref_links[a]);if(e.id.indexOf("ref-fp")===0){e.on("click",function(j,n){var m=GeoAnnotator.AnnotationInfoPanelCtrl;var o=n.id.substring(6);for(var l=0;l<m.currAnnotationInfo.footprints.length;l++){var k=m.currAnnotationInfo.footprints[l];if(k.id==o){if(k.groupId==GeoAnnotator.currGroupId){GeoAnnotator.currFootprintId=k.id;GeoAnnotator.MapPanelCtrl.moveToFeature(o)}else{GeoAnnotator.currGroupId=k.groupId;GeoAnnotator.currFootprintId=k.id;var g=GeoAnnotator.ContainerTBCtrl.manuscriptList.getStore().find("id",GeoAnnotator.currGroupId);if(g>=0){var h=GeoAnnotator.ContainerTBCtrl.manuscriptList.getStore().getAt(g);GeoAnnotator.ContainerTBCtrl.manuscriptList.setValue(h.get("name"));GeoAnnotator.ContainerTBCtrl.manuscriptList.fireEvent("select",GeoAnnotator.ContainerTBCtrl.manuscriptList,h,g)}}return}}})}else{if(e.id.indexOf("ref-an")===0){var d=e.id.substring(6);c.addAnnotationTip(d,e);e.on("click",function(g,i){var h=i.id.substring(6);GeoAnnotator.AnnotationInfoPanelCtrl.loadAnnotationInfo(h)})}}}},loadAnnotationInfo:function(b){var a=GeoAnnotator.AnnotationInfoPanelCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotation/",success:function(e,d){var c=Ext.util.JSON.decode(e.responseText);if(c!=null){if(c.type=="issue"){GeoAnnotator.currIssueId=c.id;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=c.id}GeoAnnotator.AnnotationInfoPanelCtrl.update()}},failure:function(){alert("failed to load annotation info!")},params:{annotationId:b,userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId},})},addAnnotationTip:function(b,c){var a=GeoAnnotator.AnnotationInfoPanelCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotation/",success:function(g,e){var f=GeoAnnotator.AnnotationInfoPanelCtrl;var d=Ext.util.JSON.decode(g.responseText);if(d!=null){new Ext.ToolTip({width:200,target:e.target,html:"<i>"+d.userName+"</i> says: <br>"+d.excerpt})}},failure:function(){alert("failed to load annotation info!")},params:{annotationId:b,userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId},target:c})},parseAnnotationContent:function(g){var h=/\[\[[a-z,0-9,|,_,\s]+\]\]/gi;var f=null;if(h.test(g)){var e=g.match(h);for(var c=0;c<e.length;c++){f=e[c];var d=f.substring(2,f.length-2);var a=d.split("|")[0];var b=d.split("|")[1];var j='<a href="#" class="ref-link" id="ref-'+b+'">'+a+"</a>";g=g.replace(f,j)}}return g},updateReferenceSpaceTreePanel:function(){var b=GeoAnnotator.AnnotationInfoPanelCtrl;if(b.spaceTree){b.spaceTree.clear()}var a='<div id="'+b.spaceTreeContainer+'"></div>';if(b.referenceSpaceTreePanel.body){b.referenceSpaceTreePanel.body.update(a)}},buildReferenceSpaceTree:function(){var c=GeoAnnotator.AnnotationInfoPanelCtrl;var a=c.referenceSpaceTreePanel.getInnerWidth();var b=c.referenceSpaceTreePanel.getInnerHeight();c.spaceTree=Raphael(c.spaceTreeContainer,a,b);Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Threads/",success:c.onLoadThreadsInfoSuccess,failure:function(){alert("failed to load annotation info!")},params:{annotationId:c.currAnnotationInfo.id,userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId},})},onLoadThreadsInfoSuccess:function(p){var g=Ext.util.JSON.decode(p.responseText);var c=GeoAnnotator.AnnotationInfoPanelCtrl;var n=c.referenceSpaceTreePanel.getInnerWidth();var k=c.referenceSpaceTreePanel.getInnerHeight();if(c.spaceTree){c.spaceTree.clear()}else{c.spaceTree=Raphael(c.spaceTreeContainer,n,k)}var o=c.node_height;var b=c.node_width;var l=c.min_spacing;var m,f,d;var e=c.drawThreadNode(g,n*0.5,k*0.5,b,o,c.currentNodeStyle);if(g.parents.length>0){m=(1*k-g.parents.length*o)/(g.parents.length+1);if(m<l){m=l}f=n*0.2;d=0.5*k-0.5*(o+m)*(g.parents.length-1);var q;for(var j=0;j<g.parents.length;j++){q=c.drawThreadNode(g.parents[j],f,d,b,o,c.parentNodeStyle);c.drawThreadLink(q,e);d=d+m+o}}if(g.children.length){m=(1*k-g.children.length*o)/(g.children.length+1);if(m<l){m=l}f=n*0.8;d=0.5*k-0.5*(o+m)*(g.children.length-1);var a;for(var j=0;j<g.children.length;j++){a=c.drawThreadNode(g.children[j],f,d,b,o,c.childNodeStyle);c.drawThreadLink(e,a);d=d+m+o}}},drawThreadNode:function(m,k,h,c,l,a){var d=GeoAnnotator.AnnotationInfoPanelCtrl;var i=h-0.5*l;var e=k-0.5*c;var g={};var f=d.spaceTree.rect(e,i,c,l).attr(a["default"]);var j=d.spaceTree.text(k,h,m.username+":\n"+m.excerpt.substring(0,20)).attr(a.text);var b=d.spaceTree.rect(e,i,c,l).attr(a.blanket);g.id=m.id;g.box=f;g.label=j;g.blanket=b;f.thread_node=g;j.thread_node=g;b.thread_node=g;b.hover(function(n){this.thread_node.box.attr(a.hover)},function(n){this.thread_node.box.attr(a["default"])});b.click(function(o){var n=GeoAnnotator.AnnotationInfoPanelCtrl;n.loadAnnotationInfo(this.thread_node.id)});return g},drawThreadLink:function(c,i){var a=GeoAnnotator.AnnotationInfoPanelCtrl;var h=c.blanket.getBBox().x+c.blanket.getBBox().width;var g=Math.round(c.blanket.getBBox().y+c.blanket.getBBox().height*0.5);var f=i.blanket.getBBox().x;var d=Math.round(i.blanket.getBBox().y+i.blanket.getBBox().height*0.5);var e=(h+f)*0.5;var b="M"+h+","+g+"H"+e+" V"+d+"H"+f+"l-5,5 M"+f+","+d+"l-5,-5";a.spaceTree.path(b)},updateReferenceSpaceTreePanel2:function(){var b=GeoAnnotator.AnnotationInfoPanelCtrl;var a='<div id="'+b.spaceTreeContainer+'"></div>';if(b.referenceSpaceTreePanel.body){b.referenceSpaceTreePanel.body.update(a)}},buildReferenceSpaceTree2:function(){var e=GeoAnnotator.AnnotationInfoPanelCtrl;Tree.Label.nodeHash={};Tree.Label.container=false;Tree.Label.controller=null;var b=e.referenceSpaceTreePanel.getInnerWidth();var d=e.referenceSpaceTreePanel.getInnerHeight();var a=new Canvas("stCanvas",{injectInto:e.spaceTreeContainer,width:b,height:d,styles:{fillStyle:"#ff7",strokeStyle:"#eed"}});Config.Label.height=50;Config.Label.realHeight=40;Config.Label.width=100;Config.Label.realWidth=100;Config.orientation=e.spaceTreeOrientation;Config.levelsToShow=1;e.spaceTree=new ST(a,{request:function(g,h,f){e.spaceTreeFeeder.request(g,h,f)},onCreateLabel:function(f,g){var h=Ext.get(f);f.id=g.id;h.setStyle("cursor","pointer");h.dom.innerHTML=g.name;h.on("click",function(){e.spaceTree.onClick(g.id);e.onSpaceTreeNodeClick(g.id)})},onPlaceLabel:function(f,g){var h=Ext.get(f);if(g.selected){h.addClass("selected")}else{h.removeClass("selected")}},onBeforePlotNode:function(g){var f=a.getCtx();fStyle=f.fillStyle;sStyle=f.strokeStyle;if(g.data[0].value=="comment"){f.fillStyle="#FF9797";f.strokeStyle="#FE0354"}if(g.selected){f.fillStyle="#004ee8";f.strokeStyle="#002dc3"}},onAfterPlotNode:function(g){var f=a.getCtx();f.fillStyle=fStyle;f.stroleStyle=sStyle},onBeforePlotLine:function(g){var f=a.getCtx();lineWidth=f.lineWidth;sStyle=f.strokeStyle},onAfterPlotLine:function(h){var g=a.getCtx();if(e.spaceTreeOrientation=="right"){var f=h.nodeFrom,i=h.nodeTo;var k=Tree.Geometry.getEdge(i.pos,"end");var j=Tree.Geometry.getEdge(f.pos,"begin")}else{var f=h.nodeTo,i=h.nodeFrom;var k=Tree.Geometry.getEdge(i.pos,"begin");var j=Tree.Geometry.getEdge(f.pos,"end")}a.path("stroke",function(p){var q=10;var n=p;n.save();var u=parseFloat(j.y-k.y);var m=parseFloat(j.x-k.x);var t=j.x-m/2;var s=j.y-u/2;n.translate(t,s);if(m!=0){var l=Math.atan2(u,m);n.rotate(l);n.moveTo(2,0);n.lineTo(-10,-4);n.lineTo(-10,4);n.lineTo(2,0);n.fill()}n.restore()});g.lineWidth=lineWidth;g.stroleStyle=sStyle}});e.spaceTree.move=function(f,g){this.calculatePositions(this.tree,new Complex(0,0),"endPos");Tree.Geometry.translate(this.tree,f.endPos.scale(-1).add(new Complex(-50,25)),"endPos");Tree.Plot.animate(this,$_.merge(this.controller,g,{modes:["linear"]}))};var c={id:e.currAnnotationInfo.id,name:e.currAnnotationInfo.userName+": "+e.currAnnotationInfo.excerpt,data:[{key:"type",value:e.currAnnotationInfo.type}],children:[]};e.spaceTree.loadFromJSON(c);e.spaceTree.compute();e.spaceTree.onClick(e.spaceTree.tree.id)},spaceTreeFeeder:{nodeId:"0",onComplete:null,request:function(d,e,c){var a=GeoAnnotator.AnnotationInfoPanelCtrl;var b;if(a.spaceTreeOrientation=="left"){b="child"}else{b="parent"}a.spaceTreeFeeder.nodeId=d;a.spaceTreeFeeder.onComplete=c;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"References/",success:a.spaceTreeFeeder.onRequestSuccess,failure:a.spaceTreeFeeder.onRequestFailure,params:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,annotationId:d,level:e,direction:b}})},onRequestSuccess:function(c){var b=GeoAnnotator.AnnotationInfoPanelCtrl;var a=Ext.util.JSON.decode(c.responseText);b.spaceTreeFeeder.onComplete.onComplete(b.spaceTreeFeeder.nodeId,a)},onRequestFailure:function(){alert("fail to get node info.")}},updatePanelContent:function(){var a=GeoAnnotator.AnnotationInfoPanelCtrl;if(a.containerPanel.body!=null){}a.updateAnnotationInfoDisplayPanel();var b=a.annotationInfoWrapper.getTopToolbar();if(a.currAnnotationInfo.userId==GeoAnnotator.currUserId&&parseInt(a.currAnnotationInfo.replies)<=0){b.items.get("annotation-edit-btn").enable();b.items.get("annotation-delete-btn").enable()}else{b.items.get("annotation-edit-btn").disable();b.items.get("annotation-delete-btn").disable()}b.show();if(a.referenceSpaceTreeWindow&&a.referenceSpaceTreeWindow.hidden==false){a.buildReferenceSpaceTree()}},switchSpaceTreeOrientation:function(c,i){var g=GeoAnnotator.AnnotationInfoPanelCtrl;if(!c){var j=Ext.menu.MenuMgr.get("reference-display-menu");j.render();var d=j.items.items;var h=d[0],a=d[1];if(h.checked){a.setChecked(true)}else{if(a.checked){h.setChecked(true)}}return}if(i){var e=g.annotationInfoWrapper.getTopToolbar().items.get("reference-display-btn");switch(c.text){case"References":e.setIconClass("reference-display-backward");g.spaceTreeOrientation="right";break;case"Follow-ups":e.setIconClass("reference-display-forward");g.spaceTreeOrientation="left";break}g.update()}},onLoadAnnotationInfoSuccess:function(e){var c=GeoAnnotator.AnnotationInfoPanelCtrl;c.currAnnotationInfo=Ext.util.JSON.decode(e.responseText);if(c.currAnnotationInfo!=null){c.updatePanelContent();var d={};d.id=c.currAnnotationInfo.id;d.type=c.currAnnotationInfo.type;d.userName=c.currAnnotationInfo.userName;d.timeCreated=c.currAnnotationInfo.timeCreated;d.excerpt=c.currAnnotationInfo.excerpt;GeoAnnotator.AnnotationHistoryWindowCtrl.add(d);GeoAnnotator.currFootprintId="0";if(c.currAnnotationInfo.groupId!=GeoAnnotator.currGroupId){GeoAnnotator.currGroupId=c.currAnnotationInfo.groupId;var a=GeoAnnotator.ContainerTBCtrl.manuscriptList.getStore().find("id",GeoAnnotator.currGroupId);if(a>=0){var b=GeoAnnotator.ContainerTBCtrl.manuscriptList.getStore().getAt(a);GeoAnnotator.ContainerTBCtrl.manuscriptList.setValue(b.get("name"));GeoAnnotator.ContainerTBCtrl.manuscriptList.fireEvent("select",GeoAnnotator.ContainerTBCtrl.manuscriptList,b,a)}}else{GeoAnnotator.MapPanelCtrl.update()}}},onLoadAnnotationInfoFailure:function(){alert("Failed to load annotation information!")},onSpaceTreeNodeClick:function(b){var a=GeoAnnotator.AnnotationInfoPanelCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotation/",success:a.onLoadSTAnnotationInfoSuccess,failure:a.onLoadSTAnnotationInfoFailure,params:{annotationId:b,userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId}})},onLoadSTAnnotationInfoSuccess:function(e){var c=GeoAnnotator.AnnotationInfoPanelCtrl;c.currAnnotationInfo=Ext.util.JSON.decode(e.responseText);if(c.currAnnotationInfo!=null){if(c.currAnnotationInfo.type=="issue"){GeoAnnotator.currIssueId=c.currAnnotationInfo.id;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=c.currAnnotationInfo.id}GeoAnnotator.currFootprintId="0";if(c.currAnnotationInfo.groupId!=GeoAnnotator.currGroupId){GeoAnnotator.currGroupId=c.currAnnotationInfo.groupId;var a=GeoAnnotator.ContainerTBCtrl.manuscriptList.getStore().find("id",GeoAnnotator.currGroupId);if(a>=0){var b=GeoAnnotator.ContainerTBCtrl.manuscriptList.getStore().getAt(a);GeoAnnotator.ContainerTBCtrl.manuscriptList.setValue(b.get("name"));GeoAnnotator.ContainerTBCtrl.manuscriptList.fireEvent("select",GeoAnnotator.ContainerTBCtrl.manuscriptList,b,a)}}else{GeoAnnotator.MapPanelCtrl.update()}c.updatePanelContent();var d={};d.id=c.currAnnotationInfo.id;d.type=c.currAnnotationInfo.type;d.userName=c.currAnnotationInfo.userName;d.timeCreated=c.currAnnotationInfo.timeCreated;d.excerpt=c.currAnnotationInfo.excerpt;GeoAnnotator.AnnotationHistoryWindowCtrl.add(d)}},onLoadSTAnnotationInfoFailure:function(){alert("Failed to load annotation information!")},onCommentClick:function(){var b=GeoAnnotator.AnnotationInfoPanelCtrl;var a=GeoAnnotator.MapPanelCtrl.containerPanel.getTopToolbar().items.get("toolbox-group");if(a){a.items.get("contribute-btn").toggle(true)}b.addAnnotationToReference();GeoAnnotator.ContributePanelCtrl.contributeFormPanel.get("newAnnotationContent").focus()},onCommentSubmit:function(){var a=GeoAnnotator.AnnotationInfoPanelCtrl;var b={};b.content=a.commentWindow.items.get("comment-form").getForm().findField("newCommentContent").getValue();if(b.content.length==0){Ext.Msg.alert("Error","The content of the comment cannot be empty");return}b.userId=GeoAnnotator.currUserId;b.groupId=GeoAnnotator.currGroupId;b.shareLevel=a.currAnnotationInfo.shareLevel;b.issue=false;b.timeCreated=new Date().toGMTString();b.contextMap=GeoAnnotator.ContributePanelCtrl.getContextMap();b.references=[];b.references.push(a.currAnnotationInfo.id);b.footprints=[];GeoAnnotator.ContributePanelCtrl.submitContributeFormData(b);a.commentWindow.hide()},onBookmarkClick:function(){GeoAnnotator.AnnotationBookmarkWindowCtrl.add(GeoAnnotator.AnnotationInfoPanelCtrl.currAnnotationInfo)},onThreadClick:function(){var a=GeoAnnotator.AnnotationInfoPanelCtrl;if(a.referenceSpaceTreeWindow===null){a.referenceSpaceTreePanel=new Ext.Panel({id:"reference-spaceTree-panel",bodyStyle:"padding:0px;border-left:none;border-right:none;",html:'<div id="'+a.spaceTreeContainer+'"></div>'});a.referenceSpaceTreeWindow=new Ext.Window({layout:"fit",width:600,height:480,closeAction:"hide",plain:true,modal:false,items:[a.referenceSpaceTreePanel]})}else{a.updateReferenceSpaceTreePanel()}a.referenceSpaceTreeWindow.show();a.buildReferenceSpaceTree()},onEditClick:function(){GeoAnnotator.ManageWindowCtrl.onAnnotationEditClick()},onDeleteClick:function(){GeoAnnotator.ManageWindowCtrl.onAnnotationDeleteClick()},addAnnotationToReference:function(){var b=GeoAnnotator.AnnotationInfoPanelCtrl;if(b.currAnnotationInfo&&b.currAnnotationInfo.id){var a="[AN"+b.currAnnotationInfo.id+"]";GeoAnnotator.ContributePanelCtrl.addAnnotationToReference(b.currAnnotationInfo.id,a)}}};GeoAnnotator.ManageWindowCtrl={containerWindow:null,containerPanel:null,manageGridPanel:null,register:function(a){this.containerWindow=a;this.containerPanel=this.containerWindow.get("manage-panel")},init:function(){var a=GeoAnnotator.ManageWindowCtrl;a.createManagePanel()},createManagePanel:function(){var b=GeoAnnotator.ManageWindowCtrl;var a=new Ext.data.JsonStore({root:"annotations",totalProperty:"totalCount",idProperty:"id",fields:["id","userName","shareLevel","replies",{name:"timeCreated",type:"date"},"excerpt","type"],proxy:new Ext.data.HttpProxy({url:GeoAnnotator.baseUrl+"Annotations/"}),baseParams:{userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId,ownerOnly:"True"}});b.manageGridPanel=new Ext.grid.GridPanel({autoWidth:true,autoScroll:true,autoHeight:true,id:"manage-grid-panel",store:a,loadMask:true,columns:[{header:"Share Level",dataIndex:"shareLevel",renderer:function(c){if(parseInt(c)==3){return"Private"}else{return"Public"}},sortable:true},{header:"Type",dataIndex:"type",sortable:true},{header:"Replies",dataIndex:"replies",sortable:true},{header:"Date",dataIndex:"timeCreated",renderer:Ext.util.Format.dateRenderer("m/d/Y"),sortable:true}],viewConfig:{forceFit:true,enableRowBody:true,showPreview:true,getRowClass:function(c,f,e,d){if(this.showPreview){e.body="<p><i>"+c.data.excerpt+"</i></p>";return"x-grid3-row-expanded"}return"x-grid3-row-collapsed"}},tbar:new Ext.Toolbar({id:"manage-grid-tbar",items:[{pressed:true,enableToggle:true,text:"Show Preview",toggleHandler:function(d,e){var c=b.manageGridPanel.getView();c.showPreview=e;c.refresh()}},{xtype:"tbseparator"},{text:"Edit",id:"manage-annotation-edit-btn",iconCls:"annotation-edit-icon",disabled:true,handler:b.onAnnotationEditClick},{text:"Delete",id:"manage-annotation-delete-btn",iconCls:"annotation-delete-icon",disabled:true,handler:b.onAnnotationDeleteClick}]}),bbar:new Ext.PagingToolbar({store:a,pageSize:10,displayInfo:true,displayMsg:"Annotations {0} - {1} of {2}",emptyMsg:"No Annotations to display"})});b.manageGridPanel.on("rowclick",b.onManageGridPanelRowClick);a.load({params:{start:0,limit:10}});if(b.containerPanel.items){b.containerPanel.removeAll()}b.containerPanel.add(b.manageGridPanel);b.containerPanel.doLayout();b.containerWindow.on("hide",function(){var c=GeoAnnotator.MapPanelCtrl.containerPanel.getTopToolbar().items.get("toolbox-group");if(c){c.items.get("manage-btn").toggle(false)}})},update:function(){var a=GeoAnnotator.ManageWindowCtrl;a.createManagePanel()},onManageGridPanelRowClick:function(c,b,f){var d=GeoAnnotator.ManageWindowCtrl;var a=c.getStore().getAt(b);if(a.get("type")=="issue"){GeoAnnotator.currIssueId=a.get("id");GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=a.get("id")}GeoAnnotator.currFootprintId="0";GeoAnnotator.AnnotationInfoPanelCtrl.update();if(parseInt(a.get("shareLevel"))>=3||parseInt(a.get("replies"))<=0){d.manageGridPanel.getTopToolbar().items.get("manage-annotation-edit-btn").setDisabled(false);d.manageGridPanel.getTopToolbar().items.get("manage-annotation-delete-btn").setDisabled(false)}else{d.manageGridPanel.getTopToolbar().items.get("manage-annotation-edit-btn").setDisabled(true);d.manageGridPanel.getTopToolbar().items.get("manage-annotation-delete-btn").setDisabled(true)}},onAnnotationEditClick:function(){var d=GeoAnnotator.ManageWindowCtrl;var b=GeoAnnotator.ContributePanelCtrl.contributeFormPanel;contributePanel.expand(false);var e=GeoAnnotator.AnnotationInfoPanelCtrl.currAnnotationInfo;b.getForm().findField("newAnnotationId").setValue(e.id);b.getForm().findField("newAnnotationContent").setValue(e.content);var c=b.getForm().findField("shareLevelGroup").items;for(var a=0;a<c.items.length;a++){if(a==parseInt(e.shareLevel)){c.items[a].setValue(true)}else{c.items[a].setValue(false)}}b.get("newAnnotationContent").focus()},onAnnotationDeleteClick:function(){Ext.Msg.confirm("Delete the annotation?","Are you sure that you want to delete the current annotation?",function(a,c){if(a=="yes"){var b=GeoAnnotator.ManageWindowCtrl;Ext.Ajax.request({url:GeoAnnotator.baseUrl+"Annotation/",success:b.onDeleteAnnotationSuccess,failure:b.onDeleteAnnotationFailure,params:{"delete":GeoAnnotator.AnnotationInfoPanelCtrl.currAnnotationInfo.id,userId:GeoAnnotator.currUserId,groupId:GeoAnnotator.currGroupId}})}})},onDeleteAnnotationSuccess:function(b){var a=GeoAnnotator.ManageWindowCtrl;GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId="0";GeoAnnotator.currFootprintId="0";GeoAnnotator.AnnotationInfoPanelCtrl.init();GeoAnnotator.ContributePanelCtrl.update();a.update();GeoAnnotator.TimelinePanelCtrl.update();GeoAnnotator.MapPanelCtrl.update()},onDeleteAnnotationFailoure:function(){alert("failed to delete annotation")}};GeoAnnotator.AnnotationHistoryWindowCtrl={containerWindow:null,containerPanel:null,historyStore:null,historyList:null,historyLength:20,register:function(a){this.containerWindow=a;this.containerPanel=this.containerWindow.get("annotation-history-panel")},init:function(){var b=GeoAnnotator.AnnotationHistoryWindowCtrl;b.historyLength=20;var a=new Ext.XTemplate('<tpl for=".">','<div class="list-item">','<h3><span>{timeCreated:date("M d, Y")}</span>',"{userName} says:</h3>","<p>{excerpt}</p>","</div></tpl>");b.historyStore=new Ext.data.SimpleStore({fields:["id","type","userName",{name:"timeCreated",type:"date"},"excerpt"],data:[]});b.historyList=new Ext.DataView({tpl:a,store:b.historyStore,itemSelector:"div.list-item",multiSelect:true,selectedClass:"list-item-selected",overClass:"list-item-over",emptyText:"No History"});b.historyList.on("click",b.onHistoryItemClick);b.historyList.on("contextmenu",b.onHistoryContextMenu);if(b.containerPanel.items){b.containerPanel.removeAll()}b.containerPanel.add(b.historyList);b.containerWindow.on("hide",function(){GeoAnnotator.ContainerTBCtrl.containerTB.get("annotation-history-btn").toggle(false)})},onHistoryItemClick:function(f,a,c,d){var g=f.getRecord(c).get("id");var b=f.getRecord(c).get("type");if(b=="issue"){GeoAnnotator.currIssueId=g;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=g}GeoAnnotator.currFootprintId="0";GeoAnnotator.AnnotationInfoPanelCtrl.update()},onHistoryContextMenu:function(f,a,c,d){var b=GeoAnnotator.AnnotationHistoryWindowCtrl;b.ctxArguments=arguments;b.ctxNodeIndex=a;if(!b.contextMenu){b.contextMenu=new Ext.menu.Menu({id:"history-ctx",items:[{id:"quick-reply",iconCls:"quick-reply-icon",text:"Quick Reply",scope:b,handler:function(){var e=GeoAnnotator.AnnotationHistoryWindowCtrl;e.ctxArguments[0].fireEvent("click",e.ctxArguments[0],e.ctxArguments[1],e.ctxArguments[2],e.ctxArguments[3]);GeoAnnotator.AnnotationHistoryWindowCtrl.onCommentClick()}},{iconCls:"add-reference-icon",text:"Add to References",scope:b,handler:function(){var e=b.historyStore.getAt(b.ctxNodeIndex);var h=e.get("id");var g="[AN"+h+"]";GeoAnnotator.ContributePanelCtrl.addAnnotationToReference(h,g)}},"-",{text:"Remove",iconCls:"remove-icon",scope:b,handler:function(){GeoAnnotator.AnnotationHistoryWindowCtrl.historyStore.removeAt(b.ctxNodeIndex)}}]})}d.preventDefault();b.contextMenu.showAt(d.getXY())},add:function(e){var d=GeoAnnotator.AnnotationHistoryWindowCtrl;var b=d.historyStore.query("id",e.id);for(var c=0;c<b.length;c++){d.historyStore.remove(b.get(c))}var a=d.historyStore.getTotalCount();if(a>=d.historyLength){d.historyStore.removeAt(a-1)}d.historyStore.insert(0,new Ext.data.Record(e))},clear:function(){var a=GeoAnnotator.AnnotationHistoryWindowCtrl;a.historyStore.removeAll()}};GeoAnnotator.AnnotationBookmarkWindowCtrl={containerPanel:null,containerWindow:null,bookmarkStore:null,bookmarkList:null,bookmarkPanel:null,contextMenu:null,register:function(a){this.containerWindow=a;this.containerPanel=this.containerWindow.get("annotation-bookmark-panel")},init:function(){var a=GeoAnnotator.AnnotationBookmarkWindowCtrl;var b=new Ext.XTemplate('<tpl for=".">','<div class="list-item">','<h3><span>{timeCreated:date("M d, Y")}</span>',"{userName} says:</h3>","<p>{excerpt}</p>","</div></tpl>");a.bookmarkStore=new Ext.data.SimpleStore({fields:["id","type","userName",{name:"timeCreated",type:"date"},"excerpt"],data:[]});a.bookmarkList=new Ext.DataView({tpl:b,store:a.bookmarkStore,itemSelector:"div.list-item",multiSelect:true,selectedClass:"list-item-selected",overClass:"list-item-over",emptyText:"No Bookmarks"});a.bookmarkList.on("click",a.onBookmarkItemClick);a.bookmarkList.on("contextmenu",a.onBookmarkContextMenu);if(a.containerPanel.items){a.containerPanel.removeAll()}a.containerPanel.add(a.bookmarkList);a.containerWindow.on("hide",function(){GeoAnnotator.ContainerTBCtrl.containerTB.get("annotation-bookmark-btn").toggle(false)})},onBookmarkItemClick:function(f,a,c,d){var g=f.getRecord(c).get("id");var b=f.getRecord(c).get("type");if(b=="issue"){GeoAnnotator.currIssueId=g;GeoAnnotator.currCommentId="0"}else{GeoAnnotator.currIssueId="0";GeoAnnotator.currCommentId=g}GeoAnnotator.currFootprintId="0";GeoAnnotator.AnnotationInfoPanelCtrl.update()},onBookmarkContextMenu:function(f,a,c,d){var b=GeoAnnotator.AnnotationBookmarkWindowCtrl;b.ctxArguments=arguments;b.ctxNodeIndex=a;if(!b.contextMenu){b.contextMenu=new Ext.menu.Menu({id:"bookmark-ctx",items:[{id:"quick-reply",iconCls:"quick-reply-icon",text:"Quick Reply",scope:b,handler:function(){var e=GeoAnnotator.AnnotationBookmarkWindowCtrl;e.ctxArguments[0].fireEvent("click",e.ctxArguments[0],e.ctxArguments[1],e.ctxArguments[2],e.ctxArguments[3]);GeoAnnotator.AnnotationInfoPanelCtrl.onCommentClick()}},{iconCls:"add-reference-icon",text:"Add to References",scope:b,handler:function(){var e=b.bookmarkStore.getAt(b.ctxNodeIndex);var h=e.get("id");var g="[AN"+h+"]";GeoAnnotator.ContributePanelCtrl.addAnnotationToReference(h,g)}},"-",{text:"Remove",iconCls:"remove-icon",scope:b,handler:function(){GeoAnnotator.AnnotationBookmarkWindowCtrl.bookmarkStore.removeAt(b.ctxNodeIndex)}}]})}d.preventDefault();b.contextMenu.showAt(d.getXY())},add:function(d){var c=GeoAnnotator.AnnotationBookmarkWindowCtrl;var a=c.bookmarkStore.query("id",d.id);for(var b=0;b<a.length;b++){c.bookmarkStore.remove(a.get(b))}c.bookmarkStore.insert(0,new Ext.data.Record(d))},clear:function(){var a=GeoAnnotator.AnnotationBookmarkWindowCtrl;a.bookmarkStore.removeAll()},removeAt:function(a){var b=GeoAnnotator.AnnotationBookmarkWindowCtrl;b.bookmarkStore.removeAt(a)},update:function(){}};GeoAnnotator.Util={parseXML:function(d){if(typeof DOMParser!="ftp://ftp."){return(new DOMParser()).parseFromString(d,"application/xml")}else{if(typeof ActiveXObject!="undefined"){var c=XML.newDocument();c.loadXML(d);return c}else{var a="data:text/xml;charset=utf-8,"+encodeURIComponent(d);var b=new XMLHttpRequest();b.open("GET",a,false);b.send(null);return b.responseXML}}}};